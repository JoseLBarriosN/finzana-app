<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finzana - Sistema de Gesti贸n de Cr茅ditos</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" align="center">
    <link rel="stylesheet" href="css/styles.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="theme-color" content="#2E8B57">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Finzana">
    <link rel="apple-touch-icon" href="assets/logo.png">
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Conectando con el servidor...</p>
    </div>

    <div id="connection-status" class="connection-status hidden">Conectando...</div>

    <div id="login-screen" class="login-container hidden">
        <div class="login-box">
            <div class="login-logo"> <img src="assets/logo.png" alt="Logo de Finzana" style="width: 60px; height: auto;"></div>
            <h1>Bienvenido a Finzana</h1>
            <p>Sistema de gesti贸n de cr茅ditos</p>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Correo Electr贸nico</label>
                    <input type="email" id="email" placeholder="Ingresa tu correo" required value="barrios.nunez.joseluis@gmail.com">
                </div>
                <div class="form-group">
                    <label for="password">Contrase帽a</label>
                    <input type="password" id="password" placeholder="Ingresa tu contrase帽a" required>
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Iniciar Sesi贸n</button>
            </form>
            <p id="auth-status" class="auth-status hidden"></p>
        </div>
    </div>

    <div id="main-app" class="app-container hidden">
        <header class="app-header">
            <div class="user-info">
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div>
                    <div id="user-name">Usuario Finzana</div>
                    <div id="user-role-display">Sistema de Cr茅ditos</div>
                </div>
            </div>
            <button id="logout-btn" class="btn btn-secondary"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n</button>
        </header>

        <main class="app-content">
            <div id="view-main-menu" class="view">
                <h2>Panel de Control</h2>
                <div class="menu-grid">

                    <div class="menu-card" data-view="view-cliente" onclick="showView('view-cliente')" style="--card-color: #2E8B57;">
                        <div class="menu-icon"><i class="fas fa-user-plus"></i></div>
                        <h3>Registrar Cliente</h3>
                        <p>Agrega nuevos clientes</p>
                    </div>
                
                    <div class="menu-card" data-view="view-colocacion" onclick="showView('view-colocacion')" style="--card-color: #f4b20b;">
                        <div class="menu-icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <h3>Generar Cr茅dito</h3>
                        <p>Crea nuevos cr茅ditos</p>
                    </div>
                
                    <div class="menu-card" data-view="view-cobranza" onclick="showView('view-cobranza')" style="--card-color: #2E8B57;">
                        <div class="menu-icon"><i class="fas fa-cash-register"></i></div>
                        <h3>Registrar Pago</h3>
                        <p>Registra pagos individuales</p>
                    </div>
                
                    <div class="menu-card" data-view="view-pago-grupo" onclick="showView('view-pago-grupo')" style="--card-color: #2E8B57;">
                        <div class="menu-icon"><i class="fas fa-users-cog"></i></div>
                        <h3>Pago Grupal</h3>
                        <p>Registra el pago de un grupo</p>
                    </div>
                
                    <div class="menu-card" data-view="view-gestion-clientes" onclick="showView('view-gestion-clientes')" style="--card-color: #2E8B57;">
                        <div class="menu-icon"><i class="fas fa-users"></i></div>
                        <h3>Gesti贸n de Clientes</h3>
                        <p>Consulta y administra clientes</p>
                    </div>
                
                    <div class="menu-card" data-view="view-reportes" onclick="showView('view-reportes')" style="--card-color: #0d6efd;">
                        <div class="menu-icon"><i class="fas fa-chart-bar"></i></div>
                        <h3>Reportes B谩sicos</h3>
                        <p>Estad铆sticas del mes actual</p>
                    </div>
                
                    <div class="menu-card" data-view="view-reportes-avanzados" onclick="showView('view-reportes-avanzados')" style="--card-color: #0d6efd;">
                        <div class="menu-icon"><i class="fas fa-chart-line"></i></div>
                        <h3>Reportes Avanzados</h3>
                        <p>Reportes detallados con filtros</p>
                    </div>
                
                    <div class="menu-card" data-view="view-reportes-graficos" onclick="showView('view-reportes-graficos')" style="--card-color: #0d6efd;">
                        <div class="menu-icon"><i class="fas fa-chart-pie"></i></div>
                        <h3>Reportes con Gr谩ficos</h3>
                        <p>Visualiza el comportamiento</p>
                    </div>
                
                    <div class="menu-card" data-view="view-reporte-contable" onclick="showView('view-reporte-contable')" style="--card-color: #0d6efd;">
                        <div class="menu-icon"><i class="fas fa-print"></i></div>
                        <h3>Reporte Contable</h3>
                        <p>Flujos de efectivo por oficina</p>
                    </div>
                
                    <div class="menu-card admin-only" data-view="view-multicreditos" onclick="showView('view-multicreditos')" style="--card-color: #6f42c1;">
                        <div class="menu-icon"><i class="fas fa-network-wired"></i></div>
                        <h3>Auditor铆a Hist贸rica</h3>
                        <p>Detectar multicr茅ditos</p>
                    </div>
                
                    <div class="menu-card" data-view="view-usuarios" onclick="showView('view-usuarios')" style="--card-color: #6f42c1;">
                        <div class="menu-icon"><i class="fas fa-user-cog"></i></div>
                        <h3>Gesti贸n de Usuarios</h3>
                        <p>Administra usuarios del sistema</p>
                    </div>
                
                    <div class="menu-card" data-view="view-configuracion" onclick="showView('view-configuracion')" style="--card-color: #6f42c1;">
                        <div class="menu-icon"><i class="fas fa-cogs"></i></div>
                        <h3>Configuraci贸n</h3>
                        <p>Administra poblaciones y rutas</p>
                    </div>
                
                    <div class="menu-card" data-view="view-registrar-gasto" onclick="showView('view-registrar-gasto')" style="--card-color: #FF6347;">
                        <div class="menu-icon"><i class="fas fa-receipt"></i></div>
                        <h3>Registrar Gasto</h3>
                        <p>Gastos operativos</p>
                    </div>
                
                    <div class="menu-card" data-view="view-gestion-efectivo" onclick="showView('view-gestion-efectivo')" style="--card-color: #3CB371;">
                        <div class="menu-icon"><i class="fas fa-cash-register"></i></div>
                        <h3>Gesti贸n de Efectivo</h3>
                        <p>Balances y entregas</p>
                    </div>
                    
                    <div class="menu-card" data-view="view-hoja-corte" onclick="showView('view-hoja-corte')" style="--card-color: #dc3545;">
                        <div class="menu-icon"><i class="fas fa-cut"></i></div>
                        <h3>Hoja de Corte</h3>
                        <p>Corte de caja diario</p>
                    </div> 
                
                    <div class="menu-card" data-view="view-importar" onclick="showView('view-importar')" style="--card-color: #dc3545;">
                        <div class="menu-icon"><i class="fas fa-file-import"></i></div>
                        <h3>Importar Datos</h3>
                        <p>Carga informaci贸n desde CSV</p>
                    </div>

                    <div class="menu-card" id="btn-sync-offline-menu" onclick="handleSincronizacionOffline()" style="--card-color: #fd7e14;">
                        <div class="menu-icon"><i class="fas fa-cloud-download-alt"></i></div>
                        <h3>Modo Offline</h3>
                        <p>Descargar datos</p>
                    </div>

                    <div class="menu-card" id="btn-yubikey-test" onclick="registrarYubiKey()" style="--card-color: #6f42c1;">
                        <div class="menu-icon"><i class="fas fa-key"></i></div>
                        <h3>Registrar YubiKey</h3>
                        <p>Vincular llave de seguridad</p>
                    </div>
                    
                </div>
            </div>

            <div id="view-gestion-clientes" class="view hidden">
                <div class="view-header">
                    <h2>Gesti贸n de Clientes</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="filtros-container">
                    <h3>Filtros de B煤squeda</h3>
                    <div id="filtros-grid" class="filtros-grid">
                        <div class="form-group">
                            <label for="sucursal_filtro">Sucursal</label>
                            <select id="sucursal_filtro">
                                <option value="">Todas</option>
                                <option value="GDL">Guadalajara</option>
                                <option value="LEON">Le贸n</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="curp_filtro">CURP Cliente (individual o CSV)</label>
                            <input type="text" id="curp_filtro" placeholder="Buscar por CURP...">
                        </div>
                        <div class="form-group">
                            <label for="nombre_filtro">Nombre Cliente</label>
                            <input type="text" id="nombre_filtro" placeholder="Buscar por nombre...">
                        </div>
                        <div class="form-group">
                            <label for="id_credito_filtro">ID de Cr茅dito (Hist贸rico)</label>
                            <input type="text" id="id_credito_filtro" placeholder="Buscar por ID hist贸rico...">
                        </div>
                        <div class="form-group">
                            <label for="estado_credito_filtro">Estado del Cr茅dito</label>
                            <select id="estado_credito_filtro"></select>
                        </div>
                        <div class="form-group">
                            <label for="fecha_registro_filtro">Fecha de Registro</label>
                            <input type="date" id="fecha_registro_filtro">
                        </div>
                        <div class="form-group">
                            <label for="fecha_credito_filtro">Fecha de Cr茅dito</label>
                            <input type="date" id="fecha_credito_filtro">
                        </div>
                        <div class="form-group">
                            <label for="tipo_colocacion_filtro">Tipo de Colocaci贸n</label>
                            <select id="tipo_colocacion_filtro"></select>
                        </div>
                        <div class="form-group">
                            <label for="plazo_filtro">Plazo</label>
                            <select id="plazo_filtro"></select>
                        </div>
                        <div class="form-group">
                            <label for="curp_aval_filtro">CURP Aval</label>
                            <input type="text" id="curp_aval_filtro" placeholder="Buscar por CURP de aval...">
                        </div>
                        <div class="form-group">
                            <label for="grupo_filtro">Grupo o Poblaci贸n</label>
                            <select id="grupo_filtro"></select>
                        </div>
                        <div class="form-group" style="align-self: center;">
                            <label for="comisionista_filtro" style="display: flex; align-items: center; margin-top: 20px;">
                            <input type="checkbox" id="comisionista_filtro" style="width: auto; height: auto; margin-right: 10px;">
                            Mostrar solo Comisionistas
                            </label>
                        </div>
                    </div>
                    <div class="filtros-actions">
                        <button id="btn-aplicar-filtros" class="btn btn-primary"><i class="fas fa-search"></i> Filtrar</button>
                        <button id="btn-limpiar-filtros" class="btn btn-secondary"><i class="fas fa-times"></i> Limpiar</button>
                        <button id="btn-exportar-telefonos" class="btn btn-success hidden"><i class="fas fa-paper-plane"></i> Exportar Tel茅fonos (Difusi贸n)</button>
                    </div>
                </div>
                <div id="status_gestion_clientes"></div>
                <table class="client-table">
                    <thead>
                        <tr>
                            <th>Sucursal / Inicio Cr茅dito</th>
                            <th>CURP</th>
                            <th>Nombre</th>
                            <th>Grupo</th>
                            <th>Informaci贸n de Cr茅dito</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-clientes">
                        <tr>
                            <td colspan="6">Utiliza los filtros para buscar y mostrar clientes.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="view-usuarios" class="view hidden">
                <div class="view-header">
                    <h2>Gesti贸n de Usuarios</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>

                <div class="filtros-usuarios">
                    <h3>Filtros de B煤squeda</h3>
    
                    <div class="filtros-usuarios-grid">
                        <div class="form-group">
                            <label for="filtro-email-usuario">Email</label>
                            <input type="text" id="filtro-email-usuario" placeholder="Buscar por email...">
                        </div>
                        <div class="form-group">
                            <label for="filtro-nombre-usuario">Nombre</label>
                            <input type="text" id="filtro-nombre-usuario" placeholder="Buscar por nombre...">
                        </div>
                        <div class="form-group">
                            <label for="filtro-rol-usuario">Rol</label>
                            <select id="filtro-rol-usuario"></select>
                        </div>
                        <div class="form-group">
                            <label for="filtro-sucursal-usuario">Sucursal</label>
                            <select id="filtro-sucursal-usuario">
                                <option value="">Todas</option>
                                <option value="GDL">Guadalajara</option>
                                <option value="LEON">Le贸n</option>
                                <option value="AMBAS">Ambas</option>
                            </select>
                        </div>
                    </div>

                    <div id="global-config-container" class="hidden" style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px; border: 1px solid #90caf9; margin: 15px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center;">
                            <label for="toggle-13-global" style="display: flex; align-items: center; cursor: pointer; margin: 0; color: #0d47a1; font-weight: bold;">
                                <input type="checkbox" id="toggle-13-global" style="width: 20px; height: 20px; margin-right: 10px;">
                                <span>Habilitar Oferta de 13 Semanas (Global)</span>
                            </label>
                        </div>
                        <button type="button" id="btn-guardar-config-global" class="btn btn-sm btn-primary">
                            <i class="fas fa-save"></i> Guardar Configuraci贸n
                        </button>
                    </div>

                    <div class="filtros-usuarios-actions">
                        <button id="btn-aplicar-filtros-usuarios" class="btn btn-primary">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button id="btn-limpiar-filtros-usuarios" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>
                <div class="user-actions">
                    <button id="btn-nuevo-usuario" class="btn btn-primary"><i class="fas fa-user-plus"></i> Nuevo Usuario</button>
                    <button id="btn-verificar-duplicados" class="btn btn-warning"><i class="fas fa-users-slash"></i> Verificar Clientes Duplicados</button>
                </div>

                <div id="status_usuarios"></div>
                <div id="form-usuario-container" class="hidden">
                    <h3 id="form-usuario-titulo">Nuevo Usuario</h3>
                    <form id="form-usuario">
                        <div class="form-group">
                            <label for="nuevo-email">Email <span class="required">*</span></label>
                            <input type="email" id="nuevo-email" required>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-password">Contrase帽a <span class="required">*</span></label>
                            <input type="password" id="nuevo-password" required>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-nombre">Nombre Completo <span class="required">*</span></label>
                            <input type="text" id="nuevo-nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-rol">Rol <span class="required">*</span></label>
                            <select id="nuevo-rol" required></select>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-sucursal">Sucursal <span class="required">*</span></label>
                            <select id="nuevo-sucursal" required>
                                <option value="" disabled selected>Selecciona...</option>
                                <option value="GDL">Guadalajara</option>
                                <option value="LEON">Le贸n</option>
                                <option value="AMBAS">Ambas (Solo Gerencia/Super Admin)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-ruta">Ruta Asignada</label>
                            <select id="nuevo-ruta">
                                <option value="">-- Sin asignar --</option>
                            </select>
                            <div class="field-note">La ruta depende de la sucursal seleccionada.</div>
                        </div>  
                        <div class="form-group">
                            <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Guardar</button>
                            <button type="button" id="btn-cancelar-usuario" class="btn btn-secondary"><i class="fas fa-times"></i> Cancelar</button>
                        </div>
                    </form>
                </div>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Sucursal</th>
                            <th>Ruta</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-usuarios">
                        <tr>
                            <td colspan="7">Cargando usuarios...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="view-importar" class="view hidden">
                <div class="view-header">
                    <h2>Importar Datos</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="form-group">
                    <label for="office-select">Selecciona la Sucursal para Importar</label>
                    <select id="office-select">
                        <option value="GDL">Guadalajara</option>
                        <option value="LEON">Le贸n</option>
                    </select>
                </div>

                <div id="import-gdl-section">
                    <div class="import-tabs">
                        <div class="import-tab active" data-tab="clientes">Clientes</div>
                        <div class="import-tab" data-tab="colocacion">Colocaci贸n</div>
                        <div class="import-tab" data-tab="cobranza">Cobranza</div>
                    </div>
                    <div id="tab-gdl-clientes" class="import-tab-content">
                        <div class="import-section">
                            <h4>Formato Guadalajara - Clientes (7 columnas)</h4>
                            <p>CURP, NOMBRE, DOMICILIO, CP, TELEFONO, FECHA REGISTRO (dd-mm-yyyy), GRUPO</p>
                        </div>
                        <textarea id="datos-importar-gdl-clientes" rows="8" placeholder="Pega aqu铆 los datos CSV..."></textarea>
                    </div>
                    <div id="tab-gdl-colocacion" class="import-tab-content hidden">
                        <div class="import-section">
                            <h4>Formato Guadalajara - Colocaci贸n (13 columnas)</h4>
                            <p>CURP, NOMBRE, ID (Hist贸rico), FECHA (dd-mm-yyyy), TIPO, MONTO, PLAZO, MONTO A PAGAR, CURP AVAL, NOMBRE AVAL, GRUPO, RUTA, SALDO</p>
                        </div>
                        <textarea id="datos-importar-gdl-colocacion" rows="8" placeholder="Pega aqu铆 los datos CSV..."></textarea>
                    </div>
                    <div id="tab-gdl-cobranza" class="import-tab-content hidden">
                        <div class="import-section">
                            <h4>Formato Guadalajara - Cobranza (8 columnas)</h4>
                            <p>NOMBRE, ID CREDITO (Hist贸rico), FECHA (dd-mm-yyyy), MONTO PAGO, TIPO PAGO, GRUPO, RUTA, OFICINA (GDL)</p>
                        </div>
                        <textarea id="datos-importar-gdl-cobranza" rows="8" placeholder="Pega aqu铆 los datos CSV con 8 columnas..."></textarea>
                    </div>
                </div>

                <div id="import-leon-section" class="hidden">
                    <div class="import-tabs">
                        <div class="import-tab active" data-tab="clientes">Clientas</div>
                        <div class="import-tab" data-tab="colocacion">Colocaci贸n</div>
                        <div class="import-tab" data-tab="cobranza">Cobranza</div>
                    </div>
                    <div id="tab-leon-clientes" class="import-tab-content">
                        <div class="import-section">
                            <h4>Formato Le贸n - Clientas (7 columnas)</h4>
                            <p>CURP, NOMBRE, DOMICILIO, CP, TELEFONO, FECHA REGISTRO (dd-mm-yyyy), GRUPO</p>
                        </div>
                        <textarea id="datos-importar-leon-clientes" rows="8" placeholder="Pega aqu铆 los datos CSV..."></textarea>
                    </div>
                    <div id="tab-leon-colocacion" class="import-tab-content hidden">
                        <div class="import-section">
                            <h4>Formato Le贸n - Colocaci贸n (20 columnas)</h4>
                            <p>CURP, NOMBRE, ID (Hist贸rico), FECHA (dd-mm-yyyy), TIPO, MONTO, PLAZO, MONTO A PAGAR, CURP AVAL, NOMBRE AVAL, GRUPO, RUTA, INTERES, SALDO, ULTIMO PAGO, SALDO VENCIDO, STATUS, SALDO CAPITAL, SALDO INTERES, STJ150</p>
                        </div>
                        <textarea id="datos-importar-leon-colocacion" rows="8" placeholder="Pega aqu铆 los datos CSV..."></textarea>
                    </div>
                    <div id="tab-leon-cobranza" class="import-tab-content hidden">
                        <div class="import-section">
                            <h4>Formato Le贸n - Cobranza (8 columnas)</h4>
                            <p>NOMBRE, ID CREDITO (Hist贸rico), FECHA (dd-mm-yyyy), MONTO PAGO, TIPO PAGO, GRUPO, RUTA, OFICINA (LEON)</p>
                        </div>
                        <textarea id="datos-importar-leon-cobranza" rows="8" placeholder="Pega aqu铆 los datos CSV con 8 columnas..."></textarea>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <button id="btn-procesar-importacion" class="btn btn-primary"><i class="fas fa-file-import"></i> Procesar</button>
                    <button id="btn-limpiar-datos" class="btn btn-danger"><i class="fas fa-trash"></i> Limpiar BD (Deshabilitado)</button>
                </div>
                <div id="resultado-importacion" class="hidden">
                    <div id="estado-importacion"></div>
                    <div id="detalle-importacion"></div>
                </div>
            </div>
            
            <div id="view-configuracion" class="view hidden">
                <div class="view-header">
                    <h2>Gesti贸n de Poblaciones y Rutas</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
            
                <div id="status_configuracion" class="status-message"></div>
            
                <div class="tabs" style="margin-bottom: 20px;">
                    <button class="tab-button active" data-tab="poblaciones">
                        <i class="fas fa-map-marker-alt"></i> Poblaciones
                    </button>
                    <button class="tab-button" data-tab="rutas">
                        <i class="fas fa-route"></i> Rutas
                    </button>
                </div>
            
                <div id="tab-poblaciones" class="tab-content active">
                    <div id="tabla-poblaciones-container">
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p>Cargando poblaciones...</p>
                        </div>
                    </div>
                </div>
            
                <div id="tab-rutas" class="tab-content">
                     <div id="tabla-rutas-container">
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p>Cargando rutas...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-cliente" class="view hidden">
                <div class="view-header">
                    <h2>Registrar Cliente</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <form id="form-cliente">
                    <div class="form-group">
                        <label for="office_cliente">Oficina <span class="required">*</span></label>
                        <select id="office_cliente" required>
                            <option value="GDL" selected>Guadalajara</option>
                            <option value="LEON">Le贸n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="curp_cliente">CURP <span class="required">*</span></label>
                        <input type="text" id="curp_cliente" placeholder="18 caracteres" required maxlength="18">
                        <div class="field-note" style="display: none;">Solo Admins/Gerencia/SuperAdmin pueden editar una CURP existente.</div>
                    </div>
                    <div class="form-group">
                        <label for="nombre_cliente">Nombre Completo <span class="required">*</span></label>
                        <input type="text" id="nombre_cliente" required>
                    </div>
                    <div class="form-group">
                        <label for="domicilio_cliente">Domicilio <span class="required">*</span></label>
                        <input type="text" id="domicilio_cliente" required>
                    </div>
                    <div class="form-group">
                        <label for="cp_cliente">C贸digo Postal</label>
                        <input type="text" id="cp_cliente">
                    </div>
                    <div class="form-group">
                        <label for="telefono_cliente">Tel茅fono</label>
                        <input type="text" id="telefono_cliente">
                    </div>
                    <div class="form-group">
                        <label for="poblacion_grupo_cliente">Poblaci贸n/Grupo <span class="required">*</span></label>
                        <select id="poblacion_grupo_cliente" required></select>
                    </div>
                    <div class="form-group">
                        <label for="ruta_cliente">Ruta <span class="required">*</span></label>
                        <select id="ruta_cliente" required></select>
                    </div>
                    <div class="form-group">
                        <label for="comisionista_cliente" style="display: flex; align-items: center;">
                            <input type="checkbox" id="comisionista_cliente" style="width: auto; height: auto; margin-right: 10px;">
                            Es Comisionista (Acceso a cr茅dito de 10 semanas)
                        </label>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Guardar Cliente</button>
                        <button type="button" class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-times"></i> Cancelar</button>
                    </div>
                </form>
                <div id="status_cliente"></div>
            </div>

            <div id="view-colocacion" class="view hidden">
                <div class="view-header">
                    <h2>Generar Cr茅dito</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="form-group">
                    <label for="curp_colocacion" required maxlenght="18">CURP del Cliente <span class="required">*</span></label>
                    <div class="search-group">
                        <input type="text" id="curp_colocacion" required>
                        <button id="btnBuscarCliente_colocacion" class="btn btn-primary"><i class="fas fa-search"></i> Buscar</button>
                    </div>
                </div>
                <div id="form-colocacion" class="hidden">
                    <form id="form-credito-submit">
                        <div class="form-group">
                            <label>Nombre del Cliente</label>
                            <input type="text" id="nombre_colocacion" readonly>
                        </div>
                        <div class="form-group">
                            <label>ID del Cr茅dito</label>
                            <input type="text" id="idCredito_colocacion" readonly>
                        </div>
                        <div class="form-group">
                            <label for="tipo_colocacion">Tipo <span class="required">*</span></label>
                            <select id="tipo_colocacion" required></select>
                        </div>
                        <div class="form-group">
                            <label for="monto_colocacion">Monto <span class="required">*</span></label>
                            <select id="monto_colocacion" required></select>
                        </div>
                        <div class="form-group">
                            <label for="plazo_colocacion">Plazo (semanas) <span class="required">*</span></label>
                            <select id="plazo_colocacion" required></select>
                        </div>
                        <div class="form-group">
                            <label>Monto Total a Pagar</label>
                            <input type="text" id="montoTotal_colocacion" readonly>
                            <div class="field-note">Calculado seg煤n plazo (0%, 30% o 40%)</div>
                        </div>
                        <div class="form-group">
                            <label for="curpAval_colocacion">CURP Aval <span class="required">*</span></label>
                            <input type="text" id="curpAval_colocacion" placeholder="18 caracteres" required maxlength="18">
                            <div class="field-note">18 caracteres</div>
                        </div>
                        <div class="form-group">
                            <label for="nombreAval_colocacion">Nombre Aval <span class="required">*</span></label>
                            <input type="text" id="nombreAval_colocacion" required>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-success"><i class="fas fa-hand-holding-usd"></i> Generar Cr茅dito</button>
                            <button type="button" class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-times"></i> Cancelar</button>
                        </div>
                    </form>
                </div>
                <div id="status_colocacion"></div>
            </div>

            <div id="view-cobranza" class="view hidden">
                <div class="view-header">
                    <h2>Registrar Pago</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="form-group">
                    <label for="idCredito_cobranza">ID del Cr茅dito (Hist贸rico) <span class="required">*</span></label>
                    <div class="search-group">
                        <input type="text" id="idCredito_cobranza" required>
                        <button id="btnBuscarCredito_cobranza" class="btn btn-primary"><i class="fas fa-search"></i> Buscar</button>
                    </div>
                </div>
                <div id="form-cobranza" class="hidden">
                    <form id="form-pago-submit">
                        <div class="form-group">
                            <label>Nombre Cliente</label>
                            <input type="text" id="nombre_cobranza" readonly>
                        </div>
                        <div class="form-group">
                            <label>Saldo Actual</label>
                            <input type="text" id="saldo_cobranza" readonly>
                        </div>
                        <div class="form-group">
                            <label>Estado del Cr茅dito</label>
                            <input type="text" id="estado_cobranza" readonly>
                        </div>
                        <div class="form-group">
                            <label>Semanas de Atraso (informativo)</label>
                            <input type="text" id="semanas_atraso_cobranza" readonly>
                        </div>
                        <div class="form-group">
                            <label for="pago_semanal_cobranza">Monto de Pago Semanal</label>
                            <input type="text" id="pago_semanal_cobranza" readonly>
                        </div>
                        <div class="form-group">
                            <label for="fecha_proximo_pago_cobranza">Fecha Pr贸ximo Pago (te贸rico)</label>
                            <input type="text" id="fecha_proximo_pago_cobranza" readonly>
                        </div>
                        <div class="form-group">
                            <label for="monto_cobranza">Monto del Pago <span class="required">*</span></label>
                            <input type="number" id="monto_cobranza" min="0.01" step="0.01" required>
                        </div>
                        <div class="form-group hidden" id="div-fecha-manual-container" style="background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba; margin-bottom: 15px;">
                            <label for="fecha_cobranza_manual" style="color: #856404; font-weight: bold;"> Fecha del Pago (Solo Admins)</label>
                            <input type="date" id="fecha_cobranza_manual" class="form-control">
                            <small style="display:block; color:#856404; font-size:0.8em; margin-top:3px;">
                                salo para regularizar cr茅ditos registrando pagos de fechas anteriores.
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="tipo_cobranza">Tipo de Pago <span class="required">*</span></label>
                            <select id="tipo_cobranza" required>
                                <option value="normal">Normal</option>
                                <option value="adelanto">Adelanto</option>
                                <option value="actualizado">Actualizado (Renovaci贸n)</option>
                                <option value="extraordinario">Extraordinario</option>
                                <option value="bancario">Bancario / Transferencia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Saldo Despu茅s del Pago</label>
                            <input type="text" id="saldoDespues_cobranza" readonly>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-success"><i class="fas fa-cash-register"></i> Registrar Pago</button>
                            <button type="button" class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-times"></i> Cancelar</button>
                        </div>
                    </form>
                </div>
                <div id="status_cobranza"></div>
            </div>

            <div id="view-pago-grupo" class="view hidden">
                <div class="view-header">
                    <h2><i class="fas fa-users"></i> Pago Grupal / Ruta</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu">
                        <i class="fas fa-arrow-left"></i> Volver al Men煤
                    </button>
                </div>

                <div id="status_pago_grupo" class="status-message hidden"></div>

                <div id="selector-poblaciones-card" class="card hidden" style="margin-bottom: 20px; padding: 0; border: 1px solid #dee2e6; border-left: 5px solid var(--primary); overflow: hidden;">
                    
                    <div class="group-header-clickable" onclick="toggleSelectorMain()" 
                         style="background-color: #f8f9fa; padding: 15px; display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee;">
                        <div style="display:flex; align-items:center;">
                            <i class="fas fa-chevron-down toggle-icon" id="icon-selector-main"></i>
                            <h4 style="margin:0; color:var(--primary);">
                                <i class="fas fa-map-marked-alt"></i> 1. Selecciona Poblaciones
                            </h4>
                        </div>
                        <small style="color:#666;">(Clic para mostrar/ocultar)</small>
                    </div>

                    <div id="selector-body-wrapper" class="group-content-wrapper" style="padding: 15px;">
                        <div id="checkboxes-poblaciones-container" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
                            <p>Cargando poblaciones...</p>
                        </div>
                        <div style="text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
                            <button id="btn-calcular-seleccion" class="btn btn-primary">
                                <i class="fas fa-calculator"></i> 2. Calcular Cobranza
                            </button>
                        </div>
                    </div>
                </div>

                <div id="cobranza-ruta-placeholder" class="placeholder-content">
                    <i class="fas fa-route fa-3x"></i>
                    <p>Selecciona las poblaciones arriba y presiona "Calcular Cobranza" para comenzar.</p>
                </div>

                <div id="cobranza-ruta-container"></div>

                <div class="floating-actions">
                    <button id="btn-guardar-cobranza-offline" class="btn btn-warning hidden" title="Guardar lista para modo sin conexi贸n">
                        <i class="fas fa-save"></i> Guardar Offline
                    </button>
                    <button id="btn-ver-ruta-maps" class="btn btn-info hidden" style="margin: 0 10px;" title="Ver ruta optimizada">
                        <i class="fas fa-map-signs"></i> Ruta ptima
                    </button>
                    <button id="btn-registrar-pagos-offline" class="btn btn-success hidden" title="Registrar todos los pagos seleccionados">
                        <i class="fas fa-check-double"></i> Registrar Pagos
                    </button>
                </div>
            </div>
            <div id="view-reportes" class="view hidden">
                <div class="view-header">
                    <h2>Reportes del Sistema</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <button id="btn-actualizar-reportes" class="btn btn-primary"><i class="fas fa-sync-alt"></i> Actualizar Reportes</button>
                <div class="report-grid">
                    <div class="report-card">
                        <div class="report-icon"><i class="fas fa-users"></i></div>
                        <div class="report-value" id="total-clientes">0</div>
                        <div class="report-label">Total Clientes</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                        <div class="report-value" id="total-creditos">0</div>
                        <div class="report-label">Cr茅ditos Activos</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="report-value" id="total-cartera">$0</div>
                        <div class="report-label">Total Cartera</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="report-value" id="total-vencidos">0</div>
                        <div class="report-label">Cr茅ditos Vencidos (>7 d铆as)</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon"><i class="fas fa-receipt"></i></div>
                        <div class="report-value" id="pagos-registrados">0</div>
                        <div class="report-label">Pagos del Mes</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon"><i class="fas fa-coins"></i></div>
                        <div class="report-value" id="cobrado-mes">$0</div>
                        <div class="report-label">Cobrado Este Mes</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon"><i class="fas fa-percentage"></i></div>
                        <div class="report-value" id="tasa-recuperacion">0%</div>
                        <div class="report-label">Tasa de Recuperaci贸n</div>
                    </div>
                    <div class="report-card">
                        <div class="report-icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="report-value" id="total-comisiones">$0</div>
                        <div class="report-label">Comisiones del Mes</div>
                    </div>
                </div>
                <div id="status_reportes"></div>
            </div>

            <div id="view-reportes-avanzados" class="view hidden">
                <div class="view-header">
                    <h2>Reportes Avanzados</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="advanced-filters">
                    <h3>Filtros de Reporte</h3>
                    <div id="filtros-reportes-avanzados" class="filtros-grid">
                        <div class="form-group">
                            <label for="sucursal_filtro_reporte">Sucursal</label>
                            <select id="sucursal_filtro_reporte">
                                <option value="">Todas</option>
                                <option value="GDL">Guadalajara</option>
                                <option value="LEON">Le贸n</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="grupo_filtro_reporte">Grupo/Poblaci贸n</label>
                            <select id="grupo_filtro_reporte"><option value="">Todos</option></select>
                        </div>
                        <div class="form-group">
                            <label for="ruta_filtro_reporte">Ruta</label>
                            <select id="ruta_filtro_reporte"><option value="">Todas</option></select>
                        </div>
                        <div class="form-group">
                            <label for="tipo_credito_filtro_reporte">Tipo de Cr茅dito</label>
                            <select id="tipo_credito_filtro_reporte"><option value="">Todos</option></select>
                        </div>
                        <div class="form-group">
                            <label for="estado_credito_filtro_reporte">Estado de Cr茅dito (DB)</label>
                            <select id="estado_credito_filtro_reporte"><option value="">Todos</option></select>
                        </div>
                        <div class="form-group">
                            <label for="tipo_pago_filtro_reporte">Tipo de Pago</label>
                            <select id="tipo_pago_filtro_reporte"><option value="">Todos</option></select>
                        </div>
                        <div class="form-group">
                            <label for="curp_filtro_reporte">CURP Cliente</label>
                            <input type="text" id="curp_filtro_reporte" placeholder="Filtrar por CURP...">
                        </div>
                        <div class="form-group">
                            <label for="id_credito_filtro_reporte">ID Cr茅dito (Hist贸rico)</label>
                            <input type="text" id="id_credito_filtro_reporte" placeholder="Filtrar por ID hist贸rico...">
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-section-title">Rango de Fechas</div>
                        <div class="date-range">
                            <div class="form-group">
                                <label for="fecha_inicio_reporte">Fecha Inicio</label>
                                <input type="date" id="fecha_inicio_reporte">
                            </div>
                            <div class="form-group">
                                <label for="fecha_fin_reporte">Fecha Fin</label>
                                <input type="date" id="fecha_fin_reporte">
                            </div>
                        </div>
                    </div>
                    <div class="filtros-actions">
                        <button id="btn-aplicar-filtros-reportes" class="btn btn-primary"><i class="fas fa-search"></i> Generar Reporte</button>
                        <button id="btn-limpiar-filtros-reportes" class="btn btn-secondary"><i class="fas fa-times"></i> Limpiar Filtros</button>
                    </div>
                </div>
                <div id="estadisticas-reporte"></div>
                <div class="export-buttons">
                    <button id="btn-exportar-csv" class="btn btn-success"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                    <button id="btn-exportar-pdf" class="btn btn-danger"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                </div>
                <div id="status_reportes_avanzados"></div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Tipo</th><th>CURP</th><th>Nombre</th><th>Grupo/Poblaci贸n</th><th>Ruta</th><th>Sucursal</th><th>Fecha</th><th>Tipo Operaci贸n</th><th>Monto</th><th>Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-reportes_avanzados">
                        <tr><td colspan="10">Aplica los filtros para generar el reporte.</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="view-reportes-graficos" class="view hidden">
                <div class="view-header">
                    <h2>Reportes con Gr谩ficos</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="advanced-filters">
                    <h3>Filtros del Reporte</h3>
                    <div class="filtros-grid">
                        <div class="form-group">
                            <label for="grafico_tipo_reporte">Tipo de Reporte</label>
                            <select id="grafico_tipo_reporte"></select>
                        </div>
                        <div class="form-group">
                            <label for="grafico_tipo_grafico">Tipo de Gr谩fico</label>
                            <select id="grafico_tipo_grafico">
                                <option value="bar">Barras</option>
                                <option value="pie">Pastel (Pie)</option>
                                <option value="doughnut">Dona (Doughnut)</option>
                                <option value="line">L铆neas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="grafico_agrupar_por">Agrupar Por</label>
                            <select id="grafico_agrupar_por">
                                <option value="semana">Semana</option>
                                <option value="mes">Mes</option>
                                <option value="anio">A帽o</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="grafico_sucursal">Sucursal</label>
                            <select id="grafico_sucursal">
                                <option value="">Ambas</option>
                                <option value="GDL">Guadalajara</option>
                                <option value="LEON">Le贸n</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="grafico_grupo">Grupo / Poblaci贸n</label>
                            <select id="grafico_grupo"><option value="">Todos</option></select>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-section-title">Rango de Fechas del Reporte</div>
                        <div class="date-range">
                            <div class="form-group"><label for="grafico_fecha_inicio">Fecha Inicio</label><input type="date" id="grafico_fecha_inicio"></div>
                            <div class="form-group"><label for="grafico_fecha_fin">Fecha Fin</label><input type="date" id="grafico_fecha_fin"></div>
                        </div>
                    </div>
                    <div class="filtros-actions">
                        <button id="btn-generar-grafico" class="btn btn-primary"><i class="fas fa-chart-area"></i> Generar Gr谩fico</button>
                    </div>
                    <div class="form-group">
                        <label for="grafico-colores-container">Colores Personalizados (opcional):</label>
                        <div id="grafico-colores-container" class="color-picker-container">
                            <input type="color" id="color-picker-1" value="#FF6384" title="Color 1">
                            <input type="color" id="color-picker-2" value="#36A2EB" title="Color 2">
                            <input type="color" id="color-picker-3" value="#FFCE56" title="Color 3">
                            <input type="color" id="color-picker-4" value="#4BC0C0" title="Color 4">
                            <input type="color" id="color-picker-5" value="#9966FF" title="Color 5">
                        </div>
                        <small class="field-note">Selecciona los colores para tu gr谩fico.</small>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">Resultado del Gr谩fico</div>
                    <div class="card-body">
                        <div id="grafico-container"></div>
                        <div id="status_graficos" class="status-message">Selecciona los filtros para generar un gr谩fico.</div>
                    </div>
                </div>
            </div>

            <div id="view-registrar-gasto" class="view hidden">
                <div class="view-header">
                    <h2>Registrar Gasto</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="view-content-wrapper" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                    <div class="card form-container" style="max-width: 600px; width: 100%; margin: 20px 0;">
                        <form id="form-registrar-gasto">
                            <div class="form-group">
                                <label for="gasto-monto">Monto del Gasto (*)</label>
                                <input type="number" id="gasto-monto" step="0.01" placeholder="Ej: 150.50" required>
                            </div>
                            <div class="form-group">
                                <label for="gasto-descripcion">Descripci贸n (*)</label>
                                <input type="text" id="gasto-descripcion" placeholder="Ej: Gasolina, Vi谩ticos, etc." required>
                            </div>
                            <div class="form-group">
                                <label for="gasto-fecha">Fecha del Gasto (*)</label>
                                <input type="date" id="gasto-fecha" required>
                            </div>
                            <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Guardar Gasto</button>
                        </form>
                        <div id="status_registrar_gasto" class="status-message hidden"></div>
                    </div>
                </div>
            </div>

            <div id="view-gestion-efectivo" class="view hidden">
                <div class="view-header">
                    <h2>Gesti贸n de Efectivo de Agentes</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="view-content-wrapper" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                    <div class="form-container" style="max-width: 1000px; width: 100%; margin: 20px 0;">
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>Registrar Entrega de Efectivo</h3>
                            <form id="form-registrar-entrega" class="form-inline">
                                <div class="form-group" style="flex: 2;">
                                    <label for="entrega-agente">Agente (rea Comercial)</label>
                                    <select id="entrega-agente" required><option value="">Cargando agentes...</option></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="entrega-monto">Monto Entregado</label>
                                    <input type="number" id="entrega-monto" step="0.01" placeholder="Ej: 5000" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="entrega-fecha">Fecha Entrega</label>
                                    <input type="date" id="entrega-fecha" required>
                                </div>
                                <div class="form-group" style="flex: 2;">
                                    <label for="entrega-descripcion">Descripci贸n</label>
                                    <input type="text" id="entrega-descripcion" placeholder="Ej: Efectivo semana 42">
                                </div>
                                <button type="submit" class="btn btn-success"><i class="fas fa-plus-circle"></i> Registrar Entrega</button>
                            </form>
                            
                            <div id="status_registrar_entrega" class="status-message hidden"></div>
                        </div>
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>Buscar Movimientos de Agente</h3>
                            <div id="filtros-gestion-efectivo" class="filtros-grid form-inline">
                                <div class="form-group" style="flex: 2;">
                                    <label for="filtro-agente">Agente (rea Comercial)</label>
                                    <select id="filtro-agente" required><option value="">Cargando agentes...</option></select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="filtro-fecha-inicio-efectivo">Fecha Inicio</label>
                                    <input type="date" id="filtro-fecha-inicio-efectivo">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label for="filtro-fecha-fin-efectivo">Fecha Fin</label>
                                    <input type="date" id="filtro-fecha-fin-efectivo">
                                </div>
                                <button id="btn-buscar-movimientos" class="btn btn-primary"><i class="fas fa-search"></i> Buscar Movimientos</button>
                            </div>
                        </div>
                        <div id="resultados-gestion-efectivo" class="hidden" style="max-width: 1200px; width: 100%;">
                            <div id="balance-container" class="card info-grid" style="background: #f8f9fa; padding: 15px; margin-bottom: 20px;">
                                <div class="info-item"><span class="info-label">Agente:</span><span id="balance-agente" class="info-value">...</span></div>
                                <div class="info-item"><span class="info-label">Total Entregado:</span><span id="balance-entregado" class="info-value" style="color: var(--success);">...</span></div>
                                <div class="info-item"><span class="info-label">Total Gastos:</span><span id="balance-gastos" class="info-value" style="color: var(--danger);">...</span></div>
                                <div class="info-item"><span class="info-label">Total Colocado:</span><span id="balance-colocado" class="info-value" style="color: var(--warning);">...</span></div>
                                <div class="info-item"><span class="info-label">Balance Esperado:</span><span id="balance-final" class="info-value" style="font-weight: bold; font-size: 1.1em;">...</span></div>
                            </div>
                            <h4>Historial de Movimientos</h4>
                            <div class="table-responsive">
                                <table class="report-table">
                                    <thead>
                                        <tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Descripci贸n</th><th>Registrado Por</th></tr>
                                    </thead>
                                    <tbody id="tabla-movimientos-efectivo">
                                        <tr><td colspan="5">Selecciona un agente y rango de fechas.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-reporte-contable" class="view hidden">
                <div class="view-header">
                    <h2>Reporte Contable de Efectivo</h2>
                    <button class="btn btn-secondary btn-no-print" data-view="view-main-menu"><i class="fas fa-arrow-left"></i> Volver al Men煤</button>
                </div>
                <div class="card advanced-filters btn-no-print">
                    <h3>Filtros del Reporte</h3>
                    <div class="filtros-grid">
                        <div class="form-group">
                            <label for="reporte-contable-sucursal">Sucursal</label>
                            <select id="reporte-contable-sucursal">
                                <option value="">Selecciona...</option>
                                <option value="GDL">Guadalajara</option>
                                <option value="LEON">Le贸n</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reporte-contable-agente">Agente (Opcional)</label>
                            <select id="reporte-contable-agente"><option value="">Todos los Agentes</option></select>
                        </div>
                        <div class="form-group">
                            <label for="reporte-contable-fecha-inicio">Fecha Inicio</label>
                            <input type="date" id="reporte-contable-fecha-inicio">
                        </div>
                        <div class="form-group">
                            <label for="reporte-contable-fecha-fin">Fecha Fin</label>
                            <input type="date" id="reporte-contable-fecha-fin">
                        </div>
                    </div>
                    <div class="filtros-actions">
                        <button id="btn-generar-reporte-contable" class="btn btn-primary"><i class="fas fa-search"></i> Generar Reporte</button>
                        <button id="btn-imprimir-reporte-contable" class="btn btn-success hidden"><i class="fas fa-print"></i> Confirmar e Imprimir</button>
                    </div>
                </div>
                <div id="status_reporte_contable" class="status-message hidden"></div>
                <div id="reporte-contable-wrapper" class="hidden">
                    <div id="reporte-contable-contenido" class="card" style="padding: 20px;">
                        <div id="reporte-contable-header" style="text-align: center; margin-bottom: 20px;">
                            <h3 id="reporte-contable-titulo">Reporte de Flujo de Efectivo</h3>
                            <p id="reporte-contable-subtitulo" style="font-size: 14px; color: #555;">(Selecciona filtros para generar)</p>
                        </div>
                        <h4>Resumen de Flujos</h4>
                        <div id="reporte-contable-resumen" class="info-grid" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
                        <h4>Detalle de Movimientos</h4>
                        <div id="reporte-contable-detalle"></div>
                        <div id="reporte-contable-footer" style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ccc; display: flex; justify-content: space-around; text-align: center;">
                            <div><p>_________________________</p><p><strong>Elabor贸</strong></p><p>(Administrador)</p></div>
                            <div><p>_________________________</p><p><strong>Recibi贸</strong></p><p>(Agente / Gerencia)</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-hoja-corte" class="view hidden">
                <div class="view-header">
                    <h2><i class="fas fa-cash-register"></i> Hoja de Corte</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu">
                        <i class="fas fa-arrow-left"></i> Volver al Men煤
                    </button>
                </div>
                <div class="card filters-card">
                    <div class="filters-grid" style="display: flex; gap: 15px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1;">
                            <label>Fecha de Corte:</label>
                            <input type="date" id="corte-fecha" class="form-control">
                        </div>
                        <div class="form-group" id="container-corte-agente" style="flex: 1; min-width: 200px;">
                            <label>Filtrar por Agente:</label>
                            <select id="corte-filtro-agente" class="form-control">
                                <option value="">-- Todos los Movimientos --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button id="btn-generar-corte" class="btn btn-primary" style="min-width: 150px;">
                                <i class="fas fa-sync"></i> Generar Corte
                            </button>
                        </div>
                    </div>
                </div>
                <div id="corte-resumen-cards" class="dashboard-grid" style="margin-bottom: 20px;"></div>
                <div class="card">
                    <h3>Desglose de Movimientos</h3>
                    <div class="table-responsive">
                        <table class="table" id="tabla-corte-detalle" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">Hora</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Concepto</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Descripci贸n</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; color: var(--success);">Entrada (+)</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; color: var(--danger);">Salida (-)</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ref.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" style="text-align:center; padding: 20px;">Selecciona una fecha y genera el corte.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="status_hoja_corte" class="status-message hidden"></div>
            </div>
            <div id="view-multicreditos" class="view hidden">
                <div class="view-header">
                    <h2><i class="fas fa-network-wired"></i> Auditor铆a Hist贸rica (Multicr茅ditos)</h2>
                    <button class="btn btn-secondary" data-view="view-main-menu">
                        <i class="fas fa-arrow-left"></i> Volver al Men煤
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="alert alert-info" style="margin-bottom: 20px;">
                            <i class="fas fa-info-circle"></i> 
                            Este m贸dulo detecta clientes que exceden el l铆mite de 2 cr茅ditos activos (debido a la carga hist贸rica) 
                            y muestra el desglose completo de sus pagos.
                        </div>

                        <div class="filtros-container" style="margin-bottom: 20px;">
                            <div class="filtros-grid" style="display: flex; gap: 15px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label for="multicredito-sucursal">Selecciona Sucursal</label>
                                    <select id="multicredito-sucursal" class="form-control">
                                        <option value="GDL">Guadalajara</option>
                                        <option value="LEON">Le贸n</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <button id="btn-generar-multicreditos" class="btn btn-primary" style="background-color: #6f42c1; border-color: #6f42c1; min-width: 180px;">
                                        <i class="fas fa-search"></i> Buscar Anomal铆as
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="multicreditos-resultados">
                            <div class="empty-state" style="text-align:center; color:#ccc; padding:40px;">
                                <i class="fas fa-network-wired" style="font-size: 4em; margin-bottom:10px;"></i>
                                <p>Selecciona una sucursal para auditar la cartera hist贸rica.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main> </div> <div id="processing-overlay" class="processing-overlay hidden">
        <div class="processing-spinner"></div>
        <div id="processing-message" class="processing-message">Procesando...</div>
    </div>

    <div id="progress-container-fixed" class="progress-container-nuevo hidden">
        <button id="btn-cancelar-carga-fixed" class="btn btn-danger btn-cancelar-nuevo" title="Cancelar operaci贸n">
            <i class="fas fa-times"></i>
        </button>
        <div class="progress-content-nuevo">
            <div id="progress-text-fixed" class="progress-text-nuevo">Cargando... 0%</div>
            <div class="progress-bar-wrapper-nuevo">
                <div id="progress-bar-fixed" class="progress-bar-nuevo" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <div id="generic-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Detalle</h2>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <p>Cargando...</p>
            </div>
        </div>
    </div>

    <div id="map-modal" class="modal-overlay hidden" style="z-index: 11000;">
        <div class="modal-content" style="width: 95%; height: 90%; max-width: none; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 id="map-modal-title"><i class="fas fa-map-marked-alt"></i> Ruta de Cobranza ptima</h2>
                <button id="close-map-btn" class="modal-close-btn" style="font-size: 2rem;">&times;</button>
            </div>
            
            <div id="google-map" style="flex-grow: 1; width: 100%; background: #e9ecef; min-height: 300px;"></div>
            
            <div id="route-details" style="padding: 15px; font-size: 0.9em; background: #fff; border-top: 1px solid #ddd; max-height: 150px; overflow-y: auto;">
                <p style="color:#666; text-align:center;">Calculando ruta 贸ptima...</p>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_MthfXzkr-DZk_xY5iajGXmH9xPjEuLU&libraries=places&callback=initMap" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="js/database.js"></script>
    <script src="js/app.js"></script>
    <script>
    // Registro del Service Worker con ruta relativa
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // CORRECCIN: 'sw.js' sin la barra inicial
            navigator.serviceWorker.register('sw.js')
                .then((registration) => {
                    console.log(' Service Worker registrado con 茅xito:', registration.scope);
                    
                    if (registration.waiting) {
                        console.log(' Nueva versi贸n disponible...');
                    }
                })
                .catch((err) => {
                    console.error(' Error al registrar el Service Worker:', err);
                });
        });

        // Recargar la p谩gina autom谩ticamente si el SW se actualiza
        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            refreshing = true;
            window.location.reload();
        });
    }
</script>
</body>
</html>





