<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finzana - Sistema de Gestión de Créditos</title>
    <style>
        :root {
            --primary: #2E8B57;
            --primary-dark: #1e6b47;
            --secondary: #1E90FF;
            --success: #3CB371;
            --danger: #FF6347;
            --warning: #FFA500;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1E90FF 0%, #2E8B57 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Loading Screen */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        .login-container {
            width: 100%;
            max-width: 420px;
            animation: fadeIn 0.5s ease;
        }

        .login-box {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px 30px;
            text-align: center;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .login-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            padding: 5px;
        }

        .login-box h1 {
            color: var(--dark);
            margin-bottom: 10px;
            font-weight: 700;
        }

        .login-box p {
            color: var(--gray);
            margin-bottom: 30px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.2);
        }

        input[readonly] {
            background-color: #f8f9fa;
            color: var(--gray);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            font-size: 16px;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #2e9c5f;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e64a2e;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #e69500;
        }

        .btn-menu {
            background: white;
            color: var(--dark);
            border: 1px solid #e0e0e0;
            padding: 20px;
            width: 100%;
            text-align: left;
            justify-content: flex-start;
            margin-bottom: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .btn-menu:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-back {
            background: none;
            color: var(--primary);
            padding: 10px 0;
            margin-bottom: 20px;
        }

        .btn-back:hover {
            background: none;
            color: var(--primary-dark);
        }

        /* Main App */
        .app-container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            animation: slideUp 0.5s ease;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: var(--primary);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .app-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .view {
            animation: fadeIn 0.3s ease;
        }

        .view h2, .view h3 {
            color: var(--dark);
            margin-bottom: 25px;
            font-weight: 700;
        }

        /* Search Groups */
        .search-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-group input {
            flex: 1;
            min-width: 200px;
        }

        /* Menu Grid */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .menu-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: var(--transition);
            border: 1px solid #f0f0f0;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .menu-icon {
            font-size: 40px;
            margin-bottom: 15px;
            /* Colores específicos para cada ícono */
        }

        .menu-card h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .menu-card p {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* Colores específicos para cada ícono */
        .icon-clientes {
            color: #3498db; /* Azul para gestión de clientes */
        }

        .icon-usuarios {
            color: #9b59b6; /* Púrpura para gestión de usuarios */
        }

        .icon-importar {
            color: #e74c3c; /* Rojo para importar datos */
        }

        .icon-registrar {
            color: #2ecc71; /* Verde para registrar cliente */
        }

        .icon-colocacion {
            color: #f39c12; /* Naranja para generar crédito */
        }

        .icon-cobranza {
            color: #16a085; /* Verde azulado para registrar pago */
        }

        .icon-reportes {
            color: #34495e; /* Gris oscuro para reportes */
        }

        .icon-configuracion {
            color: #7f8c8d; /* Gris para configuración */
        }

        /* Status Messages */
        .status-message {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        /* User Management Styles */
        .user-table, .client-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .user-table th,
        .user-table td,
        .client-table th,
        .client-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .user-table th,
        .client-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
        }

        .user-table tr:hover,
        .client-table tr:hover {
            background: #f8f9fa;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-admin {
            background: #e3f2fd;
            color: #1976d2;
        }

        .role-supervisor {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .role-cobrador {
            background: #e8f5e8;
            color: #388e3c;
        }

        .role-consulta {
            background: #fff3e0;
            color: #f57c00;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* Report Styles */
        .report-section {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .report-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .report-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .report-label {
            color: var(--gray);
            font-size: 14px;
        }

        /* Data Import Section */
        .import-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
        }

        .import-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .import-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .import-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        /* Credit Info Styles */
        .credito-info {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
        }

        .credito-info h5 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: var(--gray);
            font-weight: 600;
        }

        .info-value {
            font-weight: 600;
            color: var(--dark);
        }

        .status-al-corriente {
            color: var(--success);
        }

        .status-atrasado {
            color: var(--danger);
            font-weight: bold;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .menu-grid {
                grid-template-columns: 1fr;
            }

            .search-group {
                flex-direction: column;
            }

            .search-group input {
                min-width: auto;
            }

            .user-table, .client-table {
                display: block;
                overflow-x: auto;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Inicializando Finzana...</p>
    </div>

    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-hand-holding-usd" style="font-size: 40px; color: #2E8B57;"></i>
            </div>
            <h1>Bienvenido a Finzana</h1>
            <p>Sistema de gestión de créditos</p>

            <form id="login-form">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" placeholder="Ingresa tu usuario" required>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" placeholder="Ingresa tu contraseña" required>
                </div>

                <div class="form-group">
                    <label for="user-role">Rol de usuario</label>
                    <select id="user-role" required>
                        <option value="">Selecciona tu rol</option>
                        <option value="admin">Administrador</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="cobrador">Cobrador</option>
                        <option value="consulta">Consulta</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Iniciar Sesión</span>
                </button>
            </form>

            <p id="auth-status" class="auth-status"></p>
            <div style="margin-top: 20px; font-size: 14px; color: #6c757d;">
                <p><i class="fas fa-shield-alt"></i> Sistema de autenticación local</p>
            </div>
        </div>
    </div>

    <div id="main-app" class="app-container hidden">
        <header class="app-header">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <div id="user-name">Usuario Finzana</div>
                    <div id="user-role-display" style="font-size: 14px; opacity: 0.8;">Sistema de Créditos</div>
                </div>
            </div>
            <button id="logout-btn" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </button>
        </header>

        <main class="app-content">
            <div id="view-main-menu" class="view">
                <h2>Panel de Control</h2>
                <p>Selecciona una opción para gestionar el sistema</p>
                
                <div class="menu-grid">
                    <div class="menu-card" data-view="view-gestion-clientes">
                        <div class="menu-icon icon-clientes">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Gestión de Clientes</h3>
                        <p>Consulta y administra la información de clientes</p>
                        <button class="btn btn-primary" data-view="view-gestion-clientes">
                            <i class="fas fa-arrow-right"></i>
                            <span>Acceder</span>
                        </button>
                    </div>

                    <div class="menu-card" data-view="view-usuarios">
                        <div class="menu-icon icon-usuarios">
                            <i class="fas fa-user-cog"></i>
                        </div>
                        <h3>Gestión de Usuarios</h3>
                        <p>Administra usuarios y permisos del sistema</p>
                        <button class="btn btn-primary" data-view="view-usuarios">
                            <i class="fas fa-arrow-right"></i>
                            <span>Acceder</span>
                        </button>
                    </div>

                    <div class="menu-card" data-view="view-importar">
                        <div class="menu-icon icon-importar">
                            <i class="fas fa-file-import"></i>
                        </div>
                        <h3>Importar Datos</h3>
                        <p>Carga información desde archivos CSV</p>
                        <button class="btn btn-primary" data-view="view-importar">
                            <i class="fas fa-arrow-right"></i>
                            <span>Acceder</span>
                        </button>
                    </div>

                    <div class="menu-card" data-view="view-cliente">
                        <div class="menu-icon icon-registrar">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <h3>Registrar Cliente</h3>
                        <p>Agrega nuevos clientes al sistema</p>
                        <button class="btn btn-primary" data-view="view-cliente">
                            <i class="fas fa-arrow-right"></i>
                            <span>Acceder</span>
                        </button>
                    </div>

                    <div class="menu-card" data-view="view-colocacion">
                        <div class="menu-icon icon-colocacion">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <h3>Generar Crédito</h3>
                        <p>Crea nuevos créditos para clientes</p>
                        <button class="btn btn-primary" data-view="view-colocacion">
                            <i class="fas fa-arrow-right"></i>
                            <span>Acceder</span>
                        </button>
                    </div>

                    <div class="menu-card" data-view="view-cobranza">
                        <div class="menu-icon icon-cobranza">
                            <i class="fas fa-cash-register"></i>
                        </div>
                        <h3>Registrar Pago</h3>
                        <p>Registra pagos de créditos activos</p>
                        <button class="btn btn-primary" data-view="view-cobranza">
                            <i class="fas fa-arrow-right"></i>
                            <span>Acceder</span>
                        </button>
                    </div>

                    <div class="menu-card" data-view="view-reportes">
                        <div class="menu-icon icon-reportes">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>Reportes</h3>
                        <p>Consulta reportes y estadísticas</p>
                        <button class="btn btn-primary" data-view="view-reportes">
                            <i class="fas fa-arrow-right"></i>
                            <span>Acceder</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-gestion-clientes" class="view hidden">
                <!-- Gestión de clientes -->
                <h2>Gestión de Clientes</h2>
                <div class="search-group">
                    <input type="text" id="buscar-cliente" placeholder="Buscar por CURP o nombre...">
                    <button id="btn-buscar-cliente" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        <span>Buscar</span>
                    </button>
                </div>
                <div id="status_gestion_clientes"></div>
                <table class="client-table">
                    <thead>
                        <tr>
                            <th>CURP</th>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Grupo</th>
                            <th>Información de Crédito</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-clientes">
                        <!-- Los datos se cargan dinámicamente -->
                    </tbody>
                </table>
            </div>

            <div id="view-usuarios" class="view hidden">
                <!-- Gestión de usuarios -->
                <h2>Gestión de Usuarios</h2>
                <button id="btn-nuevo-usuario" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i>
                    <span>Nuevo Usuario</span>
                </button>
                <div id="status_usuarios"></div>
                
                <div id="form-usuario-container" class="hidden">
                    <h3 id="form-usuario-titulo">Nuevo Usuario</h3>
                    <form id="form-usuario">
                        <input type="hidden" id="usuario-id">
                        <div class="form-group">
                            <label for="nuevo-username">Usuario</label>
                            <input type="text" id="nuevo-username" required>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-password">Contraseña</label>
                            <input type="password" id="nuevo-password" required>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-nombre">Nombre Completo</label>
                            <input type="text" id="nuevo-nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-rol">Rol</label>
                            <select id="nuevo-rol" required>
                                <option value="admin">Administrador</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="cobrador">Cobrador</option>
                                <option value="consulta">Consulta</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="nuevo-email">Email</label>
                            <input type="email" id="nuevo-email">
                        </div>
                        <div class="form-group">
                            <label for="nuevo-telefono">Teléfono</label>
                            <input type="text" id="nuevo-telefono">
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i>
                                <span>Guardar</span>
                            </button>
                            <button type="button" id="btn-cancelar-usuario" class="btn btn-secondary">
                                <i class="fas fa-times"></i>
                                <span>Cancelar</span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-usuarios">
                        <!-- Los datos se cargan dinámicamente -->
                    </tbody>
                </table>
            </div>

            <div id="view-importar" class="view hidden">
                <!-- Importar datos -->
                <h2>Importar Datos</h2>
                <p>Importa información desde archivos CSV al sistema</p>
                
                <div class="import-tabs">
                    <div class="import-tab active" data-tab="clientes">Clientes</div>
                    <div class="import-tab" data-tab="colocacion">Colocación</div>
                    <div class="import-tab" data-tab="cobranza">Cobranza</div>
                </div>
                
                <div id="tab-clientes" class="import-tab-content">
                    <div class="import-section">
                        <h4>Formato para importar clientes</h4>
                        <p>El archivo CSV debe tener las siguientes columnas en orden:</p>
                        <ul>
                            <li>CURP</li>
                            <li>Nombre</li>
                            <li>Domicilio</li>
                            <li>Código Postal</li>
                            <li>Teléfono</li>
                            <li>Población/Grupo</li>
                            <li>Ruta (opcional)</li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <label for="datos-importar-clientes">Datos CSV</label>
                        <textarea id="datos-importar-clientes" rows="10" placeholder="Pega aquí los datos en formato CSV"></textarea>
                    </div>
                </div>
                
                <div id="tab-colocacion" class="import-tab-content hidden">
                    <div class="import-section">
                        <h4>Formato para importar colocación</h4>
                        <p>El archivo CSV debe tener las siguientes columnas en orden:</p>
                        <ul>
                            <li>CURP Cliente</li>
                            <li>Nombre Cliente</li>
                            <li>ID Crédito</li>
                            <li>Fecha Creación (YYYY-MM-DD)</li>
                            <li>Tipo</li>
                            <li>Monto</li>
                            <li>Plazo (semanas)</li>
                            <li>Monto Total</li>
                            <li>CURP Aval (opcional)</li>
                            <li>Nombre Aval (opcional)</li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <label for="datos-importar-colocacion">Datos CSV</label>
                        <textarea id="datos-importar-colocacion" rows="10" placeholder="Pega aquí los datos en formato CSV"></textarea>
                    </div>
                </div>
                
                <div id="tab-cobranza" class="import-tab-content hidden">
                    <div class="import-section">
                        <h4>Formato para importar cobranza</h4>
                        <p>El archivo CSV debe tener las siguientes columnas en orden:</p>
                        <ul>
                            <li>Nombre Cliente</li>
                            <li>ID Crédito</li>
                            <li>Fecha (YYYY-MM-DD)</li>
                            <li>Monto</li>
                            <li>Comisión</li>
                            <li>Tipo Pago</li>
                            <li>Grupo</li>
                            <li>Ruta</li>
                            <li>Semana Crédito</li>
                            <li>Saldo</li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <label for="datos-importar-cobranza">Datos CSV</label>
                        <textarea id="datos-importar-cobranza" rows="10" placeholder="Pega aquí los datos en formato CSV"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="btn-procesar-importacion" class="btn btn-primary">
                        <i class="fas fa-file-import"></i>
                        <span>Procesar Importación</span>
                    </button>
                    <button id="btn-limpiar-datos" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                        <span>Limpiar Base de Datos</span>
                    </button>
                </div>
                
                <div id="resultado-importacion" class="hidden">
                    <div id="estado-importacion"></div>
                    <div id="detalle-importacion"></div>
                </div>
            </div>

            <div id="view-cliente" class="view hidden">
                <!-- Registrar cliente -->
                <h2>Registrar Cliente</h2>
                <form id="form-cliente">
                    <div class="form-group">
                        <label for="curp_cliente">CURP</label>
                        <input type="text" id="curp_cliente" required>
                    </div>
                    <div class="form-group">
                        <label for="nombre_cliente">Nombre Completo</label>
                        <input type="text" id="nombre_cliente" required>
                    </div>
                    <div class="form-group">
                        <label for="domicilio_cliente">Domicilio</label>
                        <input type="text" id="domicilio_cliente" required>
                    </div>
                    <div class="form-group">
                        <label for="cp_cliente">Código Postal</label>
                        <input type="text" id="cp_cliente">
                    </div>
                    <div class="form-group">
                        <label for="telefono_cliente">Teléfono</label>
                        <input type="text" id="telefono_cliente">
                    </div>
                    <div class="form-group">
                        <label for="poblacion_grupo_cliente">Población/Grupo</label>
                        <input type="text" id="poblacion_grupo_cliente" required>
                    </div>
                    <div class="form-group">
                        <label for="ruta_cliente">Ruta</label>
                        <select id="ruta_cliente">
                            <option value="JC1">JC1</option>
                            <option value="JC2">JC2</option>
                            <option value="JC3">JC3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i>
                            <span>Guardar Cliente</span>
                        </button>
                        <button type="button" class="btn btn-secondary" data-view="view-main-menu">
                            <i class="fas fa-arrow-left"></i>
                            <span>Volver</span>
                        </button>
                    </div>
                </form>
                <div id="status_cliente"></div>
            </div>

            <div id="view-colocacion" class="view hidden">
                <!-- Generar crédito -->
                <h2>Generar Crédito</h2>
                <div class="form-group">
                    <label for="curp_colocacion">CURP del Cliente</label>
                    <div class="search-group">
                        <input type="text" id="curp_colocacion" placeholder="Ingresa la CURP del cliente">
                        <button id="btnBuscarCliente_colocacion" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                            <span>Buscar Cliente</span>
                        </button>
                    </div>
                </div>
                
                <div id="form-colocacion" class="hidden">
                    <div class="form-group">
                        <label for="nombre_colocacion">Nombre del Cliente</label>
                        <input type="text" id="nombre_colocacion" readonly>
                    </div>
                    <div class="form-group">
                        <label for="idCredito_colocacion">ID del Crédito</label>
                        <input type="text" id="idCredito_colocacion" readonly>
                    </div>
                    <div class="form-group">
                        <label for="tipo_colocacion">Tipo de Crédito</label>
                        <select id="tipo_colocacion" required>
                            <option value="normal">Normal</option>
                            <option value="especial">Especial</option>
                            <option value="emergente">Emergente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monto_colocacion">Monto Solicitado</label>
                        <input type="number" id="monto_colocacion" min="100" step="100" required>
                    </div>
                    <div class="form-group">
                        <label for="plazo_colocacion">Plazo (semanas)</label>
                        <input type="number" id="plazo_colocacion" min="1" max="52" required>
                    </div>
                    <div class="form-group">
                        <label for="montoTotal_colocacion">Monto Total a Pagar</label>
                        <input type="text" id="montoTotal_colocacion" readonly>
                    </div>
                    <div class="form-group">
                        <label for="curpAval_colocacion">CURP del Aval (opcional)</label>
                        <input type="text" id="curpAval_colocacion">
                    </div>
                    <div class="form-group">
                        <label for="nombreAval_colocacion">Nombre del Aval (opcional)</label>
                        <input type="text" id="nombreAval_colocacion">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span>Generar Crédito</span>
                        </button>
                        <button type="button" class="btn btn-secondary" data-view="view-main-menu">
                            <i class="fas fa-arrow-left"></i>
                            <span>Volver</span>
                        </button>
                    </div>
                </div>
                <div id="status_colocacion"></div>
            </div>

            <div id="view-cobranza" class="view hidden">
                <!-- Registrar pago -->
                <h2>Registrar Pago</h2>
                <div class="form-group">
                    <label for="idCredito_cobranza">ID del Crédito</label>
                    <div class="search-group">
                        <input type="text" id="idCredito_cobranza" placeholder="Ingresa el ID del crédito">
                        <button id="btnBuscarCredito_cobranza" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                            <span>Buscar Crédito</span>
                        </button>
                    </div>
                </div>
                
                <div id="form-cobranza" class="hidden">
                    <div class="form-group">
                        <label for="nombre_cobranza">Nombre del Cliente</label>
                        <input type="text" id="nombre_cobranza" readonly>
                    </div>
                    <div class="form-group">
                        <label for="grupo_cobranza">Grupo</label>
                        <input type="text" id="grupo_cobranza" readonly>
                    </div>
                    <div class="form-group">
                        <label for="saldo_cobranza">Saldo Actual</label>
                        <input type="text" id="saldo_cobranza" readonly>
                    </div>
                    <div class="form-group">
                        <label for="estado_cobranza">Estado del Crédito</label>
                        <input type="text" id="estado_cobranza" readonly>
                    </div>
                    <div class="form-group">
                        <label for="siguiente_pago_cobranza">Siguiente Pago</label>
                        <input type="text" id="siguiente_pago_cobranza" readonly>
                    </div>
                    <div class="form-group">
                        <label for="semanas_atraso_cobranza">Semanas de Atraso</label>
                        <input type="text" id="semanas_atraso_cobranza" readonly>
                    </div>
                    <div class="form-group">
                        <label for="monto_cobranza">Monto del Pago</label>
                        <input type="number" id="monto_cobranza" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="tipo_cobranza">Tipo de Pago</label>
                        <select id="tipo_cobranza" required>
                            <option value="normal">Normal</option>
                            <option value="extraordinario">Extraordinario</option>
                            <option value="actualizado">Actualizado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="saldoDespues_cobranza">Saldo Después del Pago</label>
                        <input type="text" id="saldoDespues_cobranza" readonly>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-cash-register"></i>
                            <span>Registrar Pago</span>
                        </button>
                        <button type="button" class="btn btn-secondary" data-view="view-main-menu">
                            <i class="fas fa-arrow-left"></i>
                            <span>Volver</span>
                        </button>
                    </div>
                </div>
                <div id="status_cobranza"></div>
            </div>

            <div id="view-reportes" class="view hidden">
                <!-- Reportes -->
                <h2>Reportes del Sistema</h2>
                <button id="btn-actualizar-reportes" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i>
                    <span>Actualizar Reportes</span>
                </button>
                
                <div class="report-grid">
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="report-value" id="total-clientes">0</div>
                        <div class="report-label">Total Clientes</div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="report-value" id="total-creditos">0</div>
                        <div class="report-label">Créditos Activos</div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="report-value" id="total-cartera">$0</div>
                        <div class="report-label">Total Cartera</div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="report-value" id="total-vencidos">0</div>
                        <div class="report-label">Créditos Vencidos</div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="report-value" id="pagos-registrados">0</div>
                        <div class="report-label">Pagos del Mes</div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="report-value" id="cobrado-mes">$0</div>
                        <div class="report-label">Cobrado Este Mes</div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="report-value" id="tasa-recuperacion">0%</div>
                        <div class="report-label">Tasa de Recuperación</div>
                    </div>
                    
                    <div class="report-card">
                        <div class="report-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div class="report-value" id="total-comisiones">$0</div>
                        <div class="report-label">Comisiones del Mes</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        // =============================================
        // SISTEMA DE BASE DE DATOS COMPLETO
        // =============================================

        class FinzanaDatabase {
            constructor() {
                this.initializeDatabase();
            }

            initializeDatabase() {
                if (!localStorage.getItem('finzana-clientes')) {
                    localStorage.setItem('finzana-clientes', JSON.stringify([]));
                }
                if (!localStorage.getItem('finzana-creditos')) {
                    localStorage.setItem('finzana-creditos', JSON.stringify([]));
                }
                if (!localStorage.getItem('finzana-pagos')) {
                    localStorage.setItem('finzana-pagos', JSON.stringify([]));
                }
                if (!localStorage.getItem('finzana-users')) {
                    this.initializeDefaultUsers();
                }
                if (!localStorage.getItem('finzana-credito-counter')) {
                    localStorage.setItem('finzana-credito-counter', '20000000');
                }
            }

            initializeDefaultUsers() {
                const defaultUsers = {
                    'admin': {
                        password: 'admin123',
                        name: 'Administrador Principal',
                        role: 'admin',
                        email: 'admin@finzana.com',
                        telefono: '',
                        fechaCreacion: new Date().toISOString()
                    },
                    'supervisor': {
                        password: 'super123',
                        name: 'Supervisor Regional',
                        role: 'supervisor',
                        email: 'supervisor@finzana.com',
                        telefono: '',
                        fechaCreacion: new Date().toISOString()
                    },
                    'cobrador1': {
                        password: 'cobra123',
                        name: 'Carlos Martínez - Cobrador JC1',
                        role: 'cobrador',
                        email: 'carlos@finzana.com',
                        telefono: '333-123-4567',
                        fechaCreacion: new Date().toISOString()
                    },
                    'consulta': {
                        password: 'consulta123',
                        name: 'Usuario de Consulta',
                        role: 'consulta',
                        email: 'consulta@finzana.com',
                        telefono: '',
                        fechaCreacion: new Date().toISOString()
                    }
                };
                this.saveUsers(defaultUsers);
            }

            // ========== USUARIOS ==========
            getUsers() {
                const users = localStorage.getItem('finzana-users');
                return users ? JSON.parse(users) : {};
            }

            saveUsers(users) {
                localStorage.setItem('finzana-users', JSON.stringify(users));
            }

            // ========== CLIENTES ==========
            getClientes() {
                const clientes = localStorage.getItem('finzana-clientes');
                return clientes ? JSON.parse(clientes) : [];
            }

            saveClientes(clientes) {
                localStorage.setItem('finzana-clientes', JSON.stringify(clientes));
            }

            buscarClientePorCURP(curp) {
                const clientes = this.getClientes();
                return clientes.find(cliente => cliente.curp === curp);
            }

            agregarCliente(cliente) {
                const clientes = this.getClientes();
                if (this.buscarClientePorCURP(cliente.curp)) {
                    return { success: false, message: 'Ya existe un cliente con esta CURP' };
                }
                cliente.id = this.generarId('CLI');
                cliente.fechaRegistro = new Date().toISOString();
                clientes.push(cliente);
                this.saveClientes(clientes);
                return { success: true, message: 'Cliente registrado exitosamente', data: cliente };
            }

            actualizarCliente(curp, datosActualizados) {
                const clientes = this.getClientes();
                const index = clientes.findIndex(cliente => cliente.curp === curp);
                if (index !== -1) {
                    datosActualizados.id = clientes[index].id;
                    datosActualizados.fechaRegistro = clientes[index].fechaRegistro;
                    clientes[index] = datosActualizados;
                    this.saveClientes(clientes);
                    return { success: true, message: 'Cliente actualizado exitosamente' };
                }
                return { success: false, message: 'Cliente no encontrado' };
            }

            eliminarCliente(curp) {
                const clientes = this.getClientes();
                const nuevosClientes = clientes.filter(cliente => cliente.curp !== curp);
                if (nuevosClientes.length < clientes.length) {
                    this.saveClientes(nuevosClientes);
                    return { success: true, message: 'Cliente eliminado exitosamente' };
                }
                return { success: false, message: 'Cliente no encontrado' };
            }

            // ========== CRÉDITOS ==========
            getCreditos() {
                const creditos = localStorage.getItem('finzana-creditos');
                return creditos ? JSON.parse(creditos) : [];
            }

            saveCreditos(creditos) {
                localStorage.setItem('finzana-creditos', JSON.stringify(creditos));
            }

            buscarCreditoPorId(idCredito) {
                const creditos = this.getCreditos();
                let credito = creditos.find(credito => credito.id === idCredito);
                if (!credito) {
                    credito = creditos.find(credito => {
                        if (credito.id.length === 8 && credito.id.endsWith(idCredito)) return true;
                        if (credito.id === idCredito) return true;
                        return false;
                    });
                }
                return credito;
            }

            buscarCreditosPorCliente(curpCliente) {
                const creditos = this.getCreditos();
                return creditos.filter(credito => credito.curpCliente === curpCliente && credito.estado === 'activo');
            }

            generarIdConsecutivo() {
                let counter = parseInt(localStorage.getItem('finzana-credito-counter')) || 20000000;
                const nuevoId = counter.toString();
                counter++;
                localStorage.setItem('finzana-credito-counter', counter.toString());
                return nuevoId;
            }

            agregarCredito(credito) {
                const creditos = this.getCreditos();
                credito.id = this.generarIdConsecutivo();
                credito.fechaCreacion = new Date().toISOString();
                credito.estado = 'activo';
                credito.montoTotal = credito.monto * 1.3;
                credito.saldo = credito.montoTotal;
                creditos.push(credito);
                this.saveCreditos(creditos);
                return { success: true, message: 'Crédito generado exitosamente', data: credito };
            }

            agregarCreditoImportado(credito) {
                const creditos = this.getCreditos();
                if (this.buscarCreditoPorId(credito.id)) {
                    return { success: false, message: 'Ya existe un crédito con este ID' };
                }
                credito.fechaCreacion = credito.fechaCreacion || new Date().toISOString();
                credito.estado = 'activo';
                credito.saldo = credito.montoTotal;
                creditos.push(credito);
                this.saveCreditos(creditos);
                return { success: true, message: 'Crédito importado exitosamente', data: credito };
            }

            // ========== PAGOS ==========
            getPagos() {
                const pagos = localStorage.getItem('finzana-pagos');
                return pagos ? JSON.parse(pagos) : [];
            }

            savePagos(pagos) {
                localStorage.setItem('finzana-pagos', JSON.stringify(pagos));
            }

            buscarPagosPorCredito(idCredito) {
                const pagos = this.getPagos();
                return pagos.filter(pago => pago.idCredito === idCredito);
            }

            agregarPago(pago) {
                const pagos = this.getPagos();
                const creditos = this.getCreditos();
                const credito = creditos.find(c => c.id === pago.idCredito);
                if (!credito) return { success: false, message: 'Crédito no encontrado' };

                if (!pago.comision) pago.comision = this.calcularComision(pago.monto, pago.tipoPago);
                credito.saldo -= pago.monto;
                if (credito.saldo <= 0) credito.estado = 'liquidado';

                pago.id = this.generarId('PAG');
                pago.fecha = new Date().toISOString();
                pago.saldoDespues = credito.saldo;

                pagos.push(pago);
                this.savePagos(pagos);
                this.saveCreditos(creditos);

                return { success: true, message: 'Pago registrado exitosamente', data: pago, credito: credito };
            }

            // ========== UTILIDADES ==========
            generarId(prefix) {
                return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }

            calcularComision(monto, tipoPago) {
                const porcentajes = { 'normal': 0.10, 'extraordinario': 0.05, 'actualizado': 0.08 };
                return monto * (porcentajes[tipoPago] || 0.10);
            }

            // ========== IMPORTACIÓN ==========
            importarDatosDesdeCSV(csvData, tipo) {
                try {
                    const lineas = csvData.split('\n').filter(linea => linea.trim());
                    const registrosImportados = [];
                    const errores = [];

                    for (let i = 0; i < lineas.length; i++) {
                        const campos = lineas[i].split(',').map(campo => campo.trim());

                        if (tipo === 'clientes') {
                            if (campos.length >= 6) {
                                const cliente = {
                                    curp: campos[0], nombre: campos[1], domicilio: campos[2] || '',
                                    cp: campos[3] || '', telefono: campos[4] || '', 
                                    poblacion_grupo: campos[5] || '', ruta: campos[6] || 'JC1'
                                };
                                if (cliente.curp && cliente.nombre) {
                                    const resultado = this.agregarCliente(cliente);
                                    if (resultado.success) registrosImportados.push(cliente);
                                    else errores.push(`Línea ${i + 1}: ${resultado.message}`);
                                } else errores.push(`Línea ${i + 1}: CURP o Nombre faltante`);
                            } else errores.push(`Línea ${i + 1}: Formato incorrecto`);
                        } else if (tipo === 'colocacion') {
                            if (campos.length >= 9) {
                                const credito = {
                                    curpCliente: campos[0], nombreCliente: campos[1], id: campos[2],
                                    fechaCreacion: campos[3] || new Date().toISOString(), tipo: campos[4],
                                    monto: parseFloat(campos[5]) || 0, plazo: parseInt(campos[6]) || 0,
                                    montoTotal: parseFloat(campos[7]) || 0, curpAval: campos[8] || '',
                                    nombreAval: campos[9] || ''
                                };
                                if (credito.curpCliente && credito.id) {
                                    const resultado = this.agregarCreditoImportado(credito);
                                    if (resultado.success) registrosImportados.push(credito);
                                    else errores.push(`Línea ${i + 1}: ${resultado.message}`);
                                } else errores.push(`Línea ${i + 1}: CURP Cliente o ID Crédito faltante`);
                            } else errores.push(`Línea ${i + 1}: Formato incorrecto`);
                        } else if (tipo === 'cobranza') {
                            if (campos.length >= 10) {
                                const pago = {
                                    nombreCliente: campos[0], idCredito: campos[1],
                                    fecha: campos[2] || new Date().toISOString(), monto: parseFloat(campos[3]) || 0,
                                    comision: parseFloat(campos[4]) || 0, tipoPago: campos[5] || 'normal',
                                    grupo: campos[6] || '', ruta: campos[7] || '', 
                                    semanaCredito: parseInt(campos[8]) || 1, saldo: parseFloat(campos[9]) || 0
                                };
                                if (pago.idCredito && pago.monto > 0) {
                                    const resultado = this.agregarPago(pago);
                                    if (resultado.success) registrosImportados.push(pago);
                                    else errores.push(`Línea ${i + 1}: ${resultado.message}`);
                                } else errores.push(`Línea ${i + 1}: ID Crédito o Monto inválido`);
                            } else errores.push(`Línea ${i + 1}: Formato incorrecto`);
                        }
                    }

                    return { success: true, total: lineas.length, importados: registrosImportados.length, errores: errores };
                } catch (error) {
                    return { success: false, message: `Error en la importación: ${error.message}` };
                }
            }

            limpiarBaseDeDatos() {
                localStorage.setItem('finzana-clientes', JSON.stringify([]));
                localStorage.setItem('finzana-creditos', JSON.stringify([]));
                localStorage.setItem('finzana-pagos', JSON.stringify([]));
                return { success: true, message: 'Base de datos limpiada exitosamente' };
            }

            // ========== GESTIÓN DE CRÉDITOS ==========
            obtenerCreditoMasReciente(curpCliente) {
                const creditos = this.getCreditos();
                const creditosCliente = creditos.filter(credito => 
                    credito.curpCliente === curpCliente && credito.estado === 'activo'
                );
                if (creditosCliente.length === 0) return null;
                creditosCliente.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
                return creditosCliente[0];
            }

            obtenerInformacionCreditoCliente(curpCliente) {
                const credito = this.obtenerCreditoMasReciente(curpCliente);
                if (!credito) return null;
                
                const pagos = this.buscarPagosPorCredito(credito.id);
                const totalPagado = pagos.reduce((sum, pago) => sum + pago.monto, 0);
                const saldoRestante = credito.saldo;
                const porcentajePagado = (totalPagado / credito.montoTotal) * 100;
                
                const fechaInicio = new Date(credito.fechaCreacion);
                const hoy = new Date();
                const diferenciaTiempo = hoy - fechaInicio;
                const semanasTranscurridas = Math.floor(diferenciaTiempo / (1000 * 60 * 60 * 24 * 7));
                const semanaActual = Math.min(semanasTranscurridas + 1, credito.plazo);
                const semanasAtraso = Math.max(0, semanasTranscurridas - credito.plazo);
                
                const siguientePago = new Date(fechaInicio);
                siguientePago.setDate(siguientePago.getDate() + (semanaActual * 7));
                const estaAlCorriente = semanasAtraso === 0 && saldoRestante > 0;
                
                return {
                    idCredito: credito.id, fechaCreacion: credito.fechaCreacion,
                    siguientePago: siguientePago.toISOString().split('T')[0], estaAlCorriente: estaAlCorriente,
                    semanasAtraso: semanasAtraso, saldoRestante: saldoRestante, semanaActual: semanaActual,
                    plazoTotal: credito.plazo, montoTotal: credito.montoTotal, totalPagado: totalPagado,
                    porcentajePagado: porcentajePagado.toFixed(1)
                };
            }

            calcularSemanasAtraso(credito) {
                const fechaInicio = new Date(credito.fechaCreacion);
                const hoy = new Date();
                const diferenciaTiempo = hoy - fechaInicio;
                const semanasTranscurridas = Math.floor(diferenciaTiempo / (1000 * 60 * 60 * 24 * 7));
                return Math.max(0, semanasTranscurridas - credito.plazo);
            }

            // ========== REPORTES ==========
            generarReportes() {
                const clientes = this.getClientes();
                const creditos = this.getCreditos();
                const pagos = this.getPagos();

                const creditosActivos = creditos.filter(c => c.estado === 'activo');
                const totalCartera = creditosActivos.reduce((sum, credito) => sum + credito.saldo, 0);
                const totalPagosMes = pagos.filter(pago => {
                    const fechaPago = new Date(pago.fecha);
                    const hoy = new Date();
                    return fechaPago.getMonth() === hoy.getMonth() && fechaPago.getFullYear() === hoy.getFullYear();
                });

                return {
                    totalClientes: clientes.length, totalCreditos: creditosActivos.length,
                    totalCartera: totalCartera, totalVencidos: creditosActivos.filter(c => this.esCreditoVencido(c)).length,
                    pagosRegistrados: totalPagosMes.length, cobradoMes: totalPagosMes.reduce((sum, pago) => sum + pago.monto, 0),
                    totalComisiones: totalPagosMes.reduce((sum, pago) => sum + pago.comision, 0)
                };
            }

            esCreditoVencido(credito) {
                const fechaCreacion = new Date(credito.fechaCreacion);
                const fechaVencimiento = new Date(fechaCreacion);
                fechaVencimiento.setDate(fechaVencimiento.getDate() + (credito.plazo * 7));
                return new Date() > fechaVencimiento;
            }
        }

        // =============================================
        // INICIALIZACIÓN DE LA APLICACIÓN
        // =============================================

        let database;
        let currentUser = null;
        let currentImportTab = 'clientes';
        let creditoActual = null;

        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar base de datos
            database = new FinzanaDatabase();
            const users = database.getUsers();

            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }, 2000);

            // Sistema de autenticación
            document.getElementById('login-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('user-role').value;

                if (users[username] && users[username].password === password && users[username].role === role) {
                    currentUser = { username: username, name: users[username].name, role: users[username].role };
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('user-name').textContent = users[username].name;
                    document.getElementById('user-role-display').textContent = users[username].role;

                    if (role === 'admin') {
                        document.getElementById('admin-menu').style.display = 'block';
                        document.getElementById('admin-menu-import').style.display = 'block';
                    }
                    localStorage.setItem('finzana-user', JSON.stringify(currentUser));
                } else {
                    document.getElementById('auth-status').textContent = 'Credenciales incorrectas. Verifica usuario, contraseña y rol.';
                    document.getElementById('auth-status').className = 'status-message status-error';
                }
            });

            // Verificar sesión activa
            const savedUser = localStorage.getItem('finzana-user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-role-display').textContent = currentUser.role;
                if (currentUser.role === 'admin') {
                    document.getElementById('admin-menu').style.display = 'block';
                    document.getElementById('admin-menu-import').style.display = 'block';
                }
            }

            // ========== EVENT LISTENERS ==========

            // Logout
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('finzana-user');
                location.reload();
            });

            // Navegación
            document.querySelectorAll('[data-view]').forEach(button => {
                button.addEventListener('click', function() {
                    const targetView = this.getAttribute('data-view');
                    showView(targetView);
                });
            });

            // Gestión de clientes
            document.getElementById('btn-buscar-cliente').addEventListener('click', loadClientesTable);
            document.getElementById('buscar-cliente').addEventListener('input', loadClientesTable);

            // Gestión de usuarios
            document.getElementById('btn-nuevo-usuario').addEventListener('click', function() {
                document.getElementById('form-usuario-container').classList.remove('hidden');
                document.getElementById('form-usuario-titulo').textContent = 'Nuevo Usuario';
                document.getElementById('form-usuario').reset();
                document.getElementById('usuario-id').value = '';
                document.getElementById('nuevo-username').readOnly = false;
            });

            document.getElementById('btn-cancelar-usuario').addEventListener('click', function() {
                document.getElementById('form-usuario-container').classList.add('hidden');
            });

            document.getElementById('form-usuario').addEventListener('submit', function(e) {
                e.preventDefault();
                const users = database.getUsers();
                const userId = document.getElementById('usuario-id').value;
                const username = document.getElementById('nuevo-username').value;
                const password = document.getElementById('nuevo-password').value;
                const nombre = document.getElementById('nuevo-nombre').value;
                const rol = document.getElementById('nuevo-rol').value;
                const email = document.getElementById('nuevo-email').value;
                const telefono = document.getElementById('nuevo-telefono').value;

                if (userId) {
                    if (users[userId]) {
                        users[userId].name = nombre;
                        users[userId].role = rol;
                        users[userId].email = email;
                        users[userId].telefono = telefono;
                        if (password) users[userId].password = password;
                        database.saveUsers(users);
                        showStatus('status_usuarios', 'Usuario actualizado exitosamente', 'success');
                    }
                } else {
                    if (users[username]) {
                        showStatus('status_usuarios', 'Ya existe un usuario con ese nombre', 'error');
                        return;
                    }
                    users[username] = { password: password, name: nombre, role: rol, email: email, telefono: telefono, fechaCreacion: new Date().toISOString() };
                    database.saveUsers(users);
                    showStatus('status_usuarios', 'Usuario creado exitosamente', 'success');
                }
                document.getElementById('form-usuario-container').classList.add('hidden');
                loadUsersTable();
            });

            // Importación
            document.querySelectorAll('.import-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.import-tab-content').forEach(c => c.classList.add('hidden'));
                    this.classList.add('active');
                    currentImportTab = this.getAttribute('data-tab');
                    document.getElementById(`tab-${currentImportTab}`).classList.remove('hidden');
                });
            });

            document.getElementById('btn-procesar-importacion').addEventListener('click', function() {
                const textareaId = `datos-importar-${currentImportTab}`;
                const csvData = document.getElementById(textareaId).value;
                if (!csvData.trim()) {
                    showStatus('estado-importacion', 'No hay datos para importar', 'error');
                    document.getElementById('resultado-importacion').classList.remove('hidden');
                    return;
                }
                const resultado = database.importarDatosDesdeCSV(csvData, currentImportTab);
                if (resultado.success) {
                    let mensaje = `Importación completada: ${resultado.importados} de ${resultado.total} registros procesados`;
                    if (resultado.errores.length > 0) {
                        mensaje += `<br>Errores: ${resultado.errores.length}`;
                        document.getElementById('detalle-importacion').innerHTML = 
                            `<strong>Detalle de errores:</strong><ul>${resultado.errores.map(e => `<li>${e}</li>`).join('')}</ul>`;
                    } else document.getElementById('detalle-importacion').innerHTML = '';
                    showStatus('estado-importacion', mensaje, 'success');
                } else showStatus('estado-importacion', resultado.message, 'error');
                document.getElementById('resultado-importacion').classList.remove('hidden');
            });

            document.getElementById('btn-limpiar-datos').addEventListener('click', function() {
                if (confirm('¿Estás seguro de que deseas limpiar toda la base de datos? Esta acción no se puede deshacer.')) {
                    const resultado = database.limpiarBaseDeDatos();
                    showStatus('estado-importacion', resultado.message, 'success');
                    document.getElementById('resultado-importacion').classList.remove('hidden');
                }
            });

            // Clientes
            document.getElementById('form-cliente').addEventListener('submit', function(e) {
                e.preventDefault();
                const cliente = {
                    curp: document.getElementById('curp_cliente').value,
                    nombre: document.getElementById('nombre_cliente').value,
                    domicilio: document.getElementById('domicilio_cliente').value,
                    cp: document.getElementById('cp_cliente').value,
                    telefono: document.getElementById('telefono_cliente').value,
                    poblacion_grupo: document.getElementById('poblacion_grupo_cliente').value,
                    ruta: document.getElementById('ruta_cliente').value
                };
                const resultado = database.agregarCliente(cliente);
                showStatus('status_cliente', resultado.message, resultado.success ? 'success' : 'error');
                if (resultado.success) document.getElementById('form-cliente').reset();
            });

            // Colocación
            document.getElementById('btnBuscarCliente_colocacion').addEventListener('click', function() {
                const curp = document.getElementById('curp_colocacion').value;
                const cliente = database.buscarClientePorCURP(curp);
                if (cliente) {
                    document.getElementById('nombre_colocacion').value = cliente.nombre;
                    document.getElementById('idCredito_colocacion').value = 'Se asignará automáticamente';
                    document.getElementById('form-colocacion').classList.remove('hidden');
                    showStatus('status_colocacion', 'Cliente encontrado', 'success');
                    calcularMontoTotalColocacion();
                } else {
                    showStatus('status_colocacion', 'Cliente no encontrado. Verifica la CURP', 'error');
                    document.getElementById('form-colocacion').classList.add('hidden');
                }
            });

            document.getElementById('monto_colocacion').addEventListener('change', calcularMontoTotalColocacion);
            document.getElementById('plazo_colocacion').addEventListener('change', calcularMontoTotalColocacion);

            document.getElementById('form-colocacion').addEventListener('submit', function(e) {
                e.preventDefault();
                const credito = {
                    curpCliente: document.getElementById('curp_colocacion').value,
                    tipo: document.getElementById('tipo_colocacion').value,
                    monto: parseFloat(document.getElementById('monto_colocacion').value),
                    plazo: parseInt(document.getElementById('plazo_colocacion').value),
                    montoTotal: parseFloat(document.getElementById('montoTotal_colocacion').value.replace('$', '').replace(',', '')),
                    curpAval: document.getElementById('curpAval_colocacion').value,
                    nombreAval: document.getElementById('nombreAval_colocacion').value
                };
                const resultado = database.agregarCredito(credito);
                showStatus('status_colocacion', resultado.message, resultado.success ? 'success' : 'error');
                if (resultado.success) {
                    document.getElementById('form-colocacion').reset();
                    document.getElementById('form-colocacion').classList.add('hidden');
                    document.getElementById('curp_colocacion').value = '';
                }
            });

            // Cobranza
            document.getElementById('btnBuscarCredito_cobranza').addEventListener('click', function() {
                const idCredito = document.getElementById('idCredito_cobranza').value.trim();
                const credito = database.buscarCreditoPorId(idCredito);
                if (credito) {
                    creditoActual = credito;
                    const cliente = database.buscarClientePorCURP(credito.curpCliente);
                    const infoCredito = database.obtenerInformacionCreditoCliente(credito.curpCliente);
                    const semanasAtraso = database.calcularSemanasAtraso(credito);
                    
                    document.getElementById('nombre_cobranza').value = cliente ? cliente.nombre : 'No encontrado';
                    document.getElementById('grupo_cobranza').value = cliente ? cliente.poblacion_grupo : 'No encontrado';
                    document.getElementById('saldo_cobranza').value = `$${credito.saldo.toLocaleString()}`;
                    document.getElementById('estado_cobranza').value = credito.estado;
                    document.getElementById('siguiente_pago_cobranza').value = infoCredito ? infoCredito.siguientePago : 'N/A';
                    document.getElementById('semanas_atraso_cobranza').value = semanasAtraso;
                    
                    if (semanasAtraso > 0) {
                        document.getElementById('tipo_cobranza').value = 'actualizado';
                        document.getElementById('tipo_cobranza').disabled = true;
                    } else document.getElementById('tipo_cobranza').disabled = false;
                    
                    document.getElementById('monto_cobranza').addEventListener('input', function() {
                        const monto = parseFloat(this.value) || 0;
                        const saldoActual = credito.saldo;
                        const saldoDespues = saldoActual - monto;
                        document.getElementById('saldoDespues_cobranza').value = `$${saldoDespues.toLocaleString()}`;
                    });
                    
                    document.getElementById('form-cobranza').classList.remove('hidden');
                    showStatus('status_cobranza', 'Crédito encontrado', 'success');
                } else {
                    showStatus('status_cobranza', 'Crédito no encontrado. Verifica el ID', 'error');
                    document.getElementById('form-cobranza').classList.add('hidden');
                }
            });

            document.getElementById('form-cobranza').addEventListener('submit', function(e) {
                e.preventDefault();
                const pago = {
                    idCredito: creditoActual.id,
                    monto: parseFloat(document.getElementById('monto_cobranza').value),
                    tipoPago: document.getElementById('tipo_cobranza').value
                };
                const resultado = database.agregarPago(pago);
                showStatus('status_cobranza', resultado.message, resultado.success ? 'success' : 'error');
                if (resultado.success) {
                    document.getElementById('form-cobranza').reset();
                    document.getElementById('form-cobranza').classList.add('hidden');
                    document.getElementById('idCredito_cobranza').value = '';
                    document.getElementById('tipo_cobranza').disabled = false;
                    creditoActual = null;
                }
            });

            // Reportes
            document.getElementById('btn-actualizar-reportes').addEventListener('click', function() {
                const reportes = database.generarReportes();
                document.getElementById('total-clientes').textContent = reportes.totalClientes;
                document.getElementById('total-creditos').textContent = reportes.totalCreditos;
                document.getElementById('total-cartera').textContent = `$${reportes.totalCartera.toLocaleString()}`;
                document.getElementById('total-vencidos').textContent = reportes.totalVencidos;
                document.getElementById('pagos-registrados').textContent = reportes.pagosRegistrados;
                document.getElementById('cobrado-mes').textContent = `$${reportes.cobradoMes.toLocaleString()}`;
                document.getElementById('total-comisiones').textContent = `$${reportes.totalComisiones.toLocaleString()}`;
                const tasaRecuperacion = reportes.totalCartera > 0 ? 
                    ((reportes.cobradoMes / reportes.totalCartera) * 100).toFixed(1) : 0;
                document.getElementById('tasa-recuperacion').textContent = `${tasaRecuperacion}%`;
            });

            // Eventos de vistas
            document.getElementById('view-reportes').addEventListener('viewshown', function() {
                document.getElementById('btn-actualizar-reportes').click();
            });
            document.getElementById('view-usuarios').addEventListener('viewshown', loadUsersTable);
            document.getElementById('view-gestion-clientes').addEventListener('viewshown', loadClientesTable);
        });

        // ========== FUNCIONES AUXILIARES ==========

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById(viewId).dispatchEvent(new Event('viewshown'));
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'status-message';
            if (type === 'success') element.classList.add('status-success');
            else if (type === 'error') element.classList.add('status-error');
            else if (type === 'info') element.classList.add('status-info');
        }

        function calcularMontoTotalColocacion() {
            const monto = parseFloat(document.getElementById('monto_colocacion').value) || 0;
            const montoTotal = monto * 1.3;
            document.getElementById('montoTotal_colocacion').value = `$${montoTotal.toLocaleString()}`;
        }

        function loadUsersTable() {
            const users = database.getUsers();
            const tbody = document.getElementById('tabla-usuarios');
            tbody.innerHTML = '';
            for (const [username, userData] of Object.entries(users)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${username}</td>
                    <td>${userData.name}</td>
                    <td><span class="role-badge role-${userData.role}">${userData.role}</span></td>
                    <td>${userData.email || ''}</td>
                    <td>${userData.telefono || ''}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-secondary" onclick="editUser('${username}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${username}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        function loadClientesTable() {
            const clientes = database.getClientes();
            const tbody = document.getElementById('tabla-clientes');
            const busqueda = document.getElementById('buscar-cliente').value.toLowerCase();
            tbody.innerHTML = '';
            const clientesFiltrados = clientes.filter(cliente => 
                cliente.curp.toLowerCase().includes(busqueda) || cliente.nombre.toLowerCase().includes(busqueda)
            );
            for (const cliente of clientesFiltrados) {
                const tr = document.createElement('tr');
                const infoCredito = database.obtenerInformacionCreditoCliente(cliente.curp);
                let infoCreditoHTML = '<em>Sin crédito activo</em>';
                if (infoCredito) {
                    const estadoClase = infoCredito.estaAlCorriente ? 'status-al-corriente' : 'status-atrasado';
                    const estadoTexto = infoCredito.estaAlCorriente ? 'Al Corriente' : `Atrasado (${infoCredito.semanasAtraso} semanas)`;
                    infoCreditoHTML = `
                        <div class="credito-info">
                            <h5>Información del Crédito</h5>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">ID Crédito:</span>
                                    <span class="info-value">${infoCredito.idCredito}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fecha Creación:</span>
                                    <span class="info-value">${new Date(infoCredito.fechaCreacion).toLocaleDateString()}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Siguiente Pago:</span>
                                    <span class="info-value">${infoCredito.siguientePago}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Estado:</span>
                                    <span class="info-value ${estadoClase}">${estadoTexto}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Saldo Restante:</span>
                                    <span class="info-value">$${infoCredito.saldoRestante.toLocaleString()}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Semana:</span>
                                    <span class="info-value">${infoCredito.semanaActual}/${infoCredito.plazoTotal}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Pagado:</span>
                                    <span class="info-value">${infoCredito.porcentajePagado}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                tr.innerHTML = `
                    <td>${cliente.curp}</td>
                    <td>${cliente.nombre}</td>
                    <td>${cliente.telefono}</td>
                    <td>${cliente.poblacion_grupo}</td>
                    <td>${infoCreditoHTML}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-secondary" onclick="editCliente('${cliente.curp}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCliente('${cliente.curp}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        function editUser(username) {
            const users = database.getUsers();
            const user = users[username];
            if (user) {
                document.getElementById('form-usuario-container').classList.remove('hidden');
                document.getElementById('form-usuario-titulo').textContent = 'Editar Usuario';
                document.getElementById('usuario-id').value = username;
                document.getElementById('nuevo-username').value = username;
                document.getElementById('nuevo-username').readOnly = true;
                document.getElementById('nuevo-password').value = '';
                document.getElementById('nuevo-password').placeholder = 'Dejar en blanco para no cambiar';
                document.getElementById('nuevo-nombre').value = user.name;
                document.getElementById('nuevo-rol').value = user.role;
                document.getElementById('nuevo-email').value = user.email || '';
                document.getElementById('nuevo-telefono').value = user.telefono || '';
            }
        }

        function deleteUser(username) {
            if (confirm(`¿Estás seguro de que deseas eliminar al usuario ${username}?`)) {
                const users = database.getUsers();
                delete users[username];
                database.saveUsers(users);
                loadUsersTable();
                showStatus('status_usuarios', 'Usuario eliminado exitosamente', 'success');
            }
        }

        function editCliente(curp) {
            const cliente = database.buscarClientePorCURP(curp);
            if (cliente) {
                document.getElementById('curp_cliente').value = cliente.curp;
                document.getElementById('curp_cliente').readOnly = true;
                document.getElementById('nombre_cliente').value = cliente.nombre;
                document.getElementById('domicilio_cliente').value = cliente.domicilio;
                document.getElementById('cp_cliente').value = cliente.cp;
                document.getElementById('telefono_cliente').value = cliente.telefono;
                document.getElementById('poblacion_grupo_cliente').value = cliente.poblacion_grupo;
                document.getElementById('ruta_cliente').value = cliente.ruta;
                document.querySelector('#form-cliente button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Actualizar Cliente';
                document.getElementById('form-cliente').onsubmit = function(e) {
                    e.preventDefault();
                    const datosActualizados = {
                        curp: document.getElementById('curp_cliente').value,
                        nombre: document.getElementById('nombre_cliente').value,
                        domicilio: document.getElementById('domicilio_cliente').value,
                        cp: document.getElementById('cp_cliente').value,
                        telefono: document.getElementById('telefono_cliente').value,
                        poblacion_grupo: document.getElementById('poblacion_grupo_cliente').value,
                        ruta: document.getElementById('ruta_cliente').value
                    };
                    const resultado = database.actualizarCliente(curp, datosActualizados);
                    showStatus('status_cliente', resultado.message, resultado.success ? 'success' : 'error');
                    if (resultado.success) {
                        document.getElementById('form-cliente').reset();
                        document.getElementById('curp_cliente').readOnly = false;
                        document.querySelector('#form-cliente button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Guardar Cliente';
                        document.getElementById('form-cliente').onsubmit = null;
                        loadClientesTable();
                    }
                };
                showView('view-cliente');
            }
        }

        function deleteCliente(curp) {
            if (confirm(`¿Estás seguro de que deseas eliminar al cliente con CURP ${curp}?`)) {
                const resultado = database.eliminarCliente(curp);
                showStatus('status_gestion_clientes', resultado.message, resultado.success ? 'success' : 'error');
                loadClientesTable();
            }
        }
    </script>
</body>
</html>
